# 渐进式开发路线 · 严格对齐（强化数据接口抽象层）【v2.1 · 个人业余版】

> 角色定位：**《02 项目文件结构 v1.3.1》= 标准（命名/文件/接口以此为准）**；**《01 流程图 v3.3》= 蓝图（通过“映射表”对应标准接口）**；**《00 策略 V2.3.1》= 规则/阈值（参数化落地）**  
> 约定：**所有“取数”必须经抽象层 `DataCollector.*`**；**严禁**在 `collector.py` 之外直接调用 akshare/eastmoney 等 API。  
> 记号：✅已就绪 | ☑️待完成 | 🧩占位骨架 | 🔗联动交付 | ⛳可独立交付 | 🛡️红线 | ⭐难度  
> **每个大块/小块都附：🧾交付物 + ✅验收**（方便个人开发自检）
> **不合理**
  - 新发现的不合理（低严重）：PCR手动计算需从期权daily接口提取数据，可能增加F2复杂度（e.g., 区分put/call需额外解析）。
                            若分钟级数据不足（AKShare多为日级），回退频繁。
  - 建议：在F2验收添加“PCR计算从option_shfe_daily等接口验证”。
---

## 🔌 大块 A0｜数据接口抽象层（⭐️⭐️⭐️）— 最高优先级
> 目标：以《02》为准，提供 **7/7 稳定 `get_*` 接口** + 可配置多数据源映射 + 容错/缓存/热更新 + “禁直连”红线可验证。

### A0.1 核心稳定接口（唯一标准）
- [ ] ⛳ `get_basic_market_data()`  
- [ ] ⛳ `get_sector_data()`  
- [ ] ⛳ `get_correlation_data()`  
- [ ] ⛳ `get_fund_flow_data()`  
- [ ] ⛳ `get_risk_indicator_data()`  *(内部可组合 QVIX/A50/两融)*  
- [ ] ⛳ `get_dragon_tiger_data()`  
- [ ] ⛳ `get_etf_flow_data()`  
- [ ] ⛳ `get_extended_data(data_type: str)` *(扩展口)*
  - 🧾交付物：`data_service/collector.py` 中上述方法 **同名存在**（含 docstring），返回最小可用结构（可先 Mock）  
  - ✅验收：`tests/test_data_interface.py::test_all_interfaces_exist` 通过；函数签名与《02》一致

### A0.2 《02》点名必须存在的 `collect_*`
- [ ] 🧩 `collect_a50_futures()`  
- [ ] 🧩 `collect_margin_data()`  
  - 🧾交付物：方法同名存在，内部仍经 `_resolve_api()` 调用映射（不直连）  
  - ✅验收：`test_data_interface.py::test_collect_required_methods` 通过

### A0.3 内部共用方法
- [ ] ☑️ `_resolve_api(method_name: str)` / `_get_provider(interface: str)` / `_fallback_to_mock(interface: str)`  
  - 🧾交付物：三方法实现与日志（trace 抓取 provider/回退）  
  - ✅验收：`test_data_interface.py::test_mapping_resolve_and_fallback` 通过

### A0.4 配置驱动（**7/7 完整映射**）
- [ ] ⛳ `config/data_source_mapping.json`（**每个 `get_*` 单独一条目**）
  - [ ] ☑️ 字段：`primary` / `fallbacks[]` / `retry{max,backoff}` / `rate_limit` / `cache_ttl`  
  - [ ] ☑️ `get_risk_indicator_data` 采用 `compose.steps`（Q=QVIX、A=A50、M=两融）  
  - [ ] ☑️ `extensions.*` 支持 `get_extended_data`  
- [ ] ☑️ `config/settings.py`：`DATA_PROVIDER_ACTIVE`、`RETRIES/BACKOFF/TIMEOUT`、`FEATURE_FLAGS`
  - 🧾交付物：最小示例 JSON、说明注释（如何切源/回退/缓存）  
  - ✅验收：`test_data_interface.py::test_config_mapping_complete(7/7)` 通过

### A0.5 容错与缓存
- [ ] ☑️ **三级缓存**：内存（短 TTL）→ 磁盘（中 TTL）→ API  
- [ ] ☑️ **熔断与降级**：连续失败→短时熔断→备源回退→MOCK  
- [ ] ☑️ **采集数据年龄闸门**：计算 `data_age`，超阈值触发降级/告警  
  - 🧾交付物：`utils/cache.py` / `utils/circuit_breaker.py` / 指标日志（命中率/失败率/延迟）  
  - ✅验收：`system_check.py` 输出“命中率/失败率/延迟”三项均有数值；`test_cache_and_cb.py` 通过

### A0.6 热更新
- [ ] ☑️ 监听 `data_source_mapping.json` mtime 自动重载  
- [ ] ☑️ `FEATURE_FLAGS` 动态开关 cache/mock/fallback  
  - 🧾交付物：热更新监听器（thread/timer）与日志  
  - ✅验收：更改映射后**无需重启**可生效（日志出现“mapping reloaded”）

### A0.7 🛡️红线（可验证）
- [ ] ☑️ **pre-commit 钩子**：`forbid-akshare-outside-collector`  
- [ ] ☑️ **CI 检查**：除 `data_service/collector.py` 外，检测到 `import akshare|eastmoney` 直接失败  
  - 🧾交付物：`.pre-commit-config.yaml` / CI 脚本  
  - ✅验收：违规则提交失败；`tests/test_data_interface.py::test_no_direct_api_calls` 通过

### A0.8 自检与可观测
- [ ] ⛳ `scripts/system_check.py`：连通/速率/失败率/缓存命中一键巡检  
- [ ] ☑️ 统一结构化日志（抽象层→清洗→入库）链路 ID  
  - 🧾交付物：脚本 + 运行报告（md 或 txt）  
  - ✅验收：`/reports/system_check_*.md` 生成且字段完整

---

## 🧱 大块 A｜基础骨架 & 最小闭环（⭐️⭐️）
> 目标：一次性对齐目录/命名与最小闭环“取数→清洗→落库→展示”，**所有数据入口走 A0**。

### A1 目录与配置
- [ ] ⛳ `config/settings.py` / `config/database_schema.sql` / `config/default_params.json`  
- [ ] ⛳ `utils/logger.py` / `utils/helpers.py` / `utils/database_manager.py`
  - 🧾交付物：数据库初始化 SQL、日志目录结构  
  - ✅验收：`make init-db` 成功、日志文件可生成

### A2 最小链路
- [ ] 🔗 `get_basic_market_data()` → `cleaner.normalize()/align_trading_calendar()/deduplicate()` → `storage.save_market_data()`  
  - 🧾交付物：最小演示脚本 `demo_min_flow.py`  
  - ✅验收：运行脚本后 DB 新增一张“市场快照”表且有行数>0

### A3 Web 最小展示
- [ ] ⛳ `run_web.py` / `web_interface/dashboard.py` / `pages/01_overview.py` / `components/*`  
  - 🧾交付物：Overview 表格 + 1 张简单曲线  
  - ✅验收：打开页面能看到 DB 真实数据

### A4 页面壳一次建齐
- [ ] 🧩 `pages/02 … 12`（与《02》同名）  
  - 🧾交付物：导航与占位组件  
  - ✅验收：所有路由可访问无报错

---

## 🔌 大块 B｜数据采集 & 清洗全量接入（⭐️⭐️⭐️）
> 目标：把《02》列出的数据源**全部**接入到 7 个 `get_*`；清洗与合并对齐；加入“多重归属合并”测试。

### B1 基础数据源
- [ ] ⛳ `get_sector_data()` → `storage.save_sector_data()`  
- [ ] ⛳ `get_risk_indicator_data()`（compose：QVIX/A50/两融）→ `save_qvix_data()` 等  
- [ ] ⛳ `collect_a50_futures()` → `save_a50_futures()`；`collect_margin_data()` → `save_margin_data()`  
  - 🧾交付物：对应表结构与最小 ETL 脚本  
  - ✅验收：`system_check.py` 中“基础数据源连通”项为绿色

### B2 概念/资金/龙虎榜/ETF
- [ ] ⛳ `get_fund_flow_data()` → `save_fund_flow_data()`  
- [ ] ⛳ `get_dragon_tiger_data()` → `save_dragon_tiger_data()`  
- [ ] ⛳ `get_etf_flow_data()` → `save_etf_flow()`  
- [ ] ⛳ **概念四口径入库**：`save_concept_snapshot()` / `save_concept_constituents()` / `save_concept_history()` / `save_concept_history_min()`  
  - 🧾交付物：四口径表结构 + 样例入库脚本  
  - ✅验收：四张概念表都存在且行数>0

### B3 清洗拼接
- [ ] 🔗 `cleaner.merge_sector_concept_mapping()`（**行业×概念多重归属合并**）  
  - 🧾交付物：3 个示例用例（含冲突优先级）+ 单测  
  - ✅验收：`tests/test_cleaner_merge.py` 通过；合并后无重复主键

---

## 📎 蓝图→标准 映射表（仅调度/文档层维护，不扩口）
- [ ] ☑️ `collect_market_data` → `get_basic_market_data`  
- [ ] ☑️ `collect_sector_data` → `get_sector_data`  
- [ ] ☑️ `collect_qvix_data` → `get_risk_indicator_data` *(QVIX 分支)*  
- [ ] ☑️ `collect_a50_futures` → `collect_a50_futures` *(同名保留)*  
- [ ] ☑️ `collect_margin_data` → `collect_margin_data` *(同名保留)*  
  - 🧾交付物：`docs/flow_to_api_mapping.md`  
  - ✅验收：调度脚本注释中引用该表，无散落直连调用

---

## 🧮 大块 C｜指标与调度（⭐️⭐️⭐️）
### C1 指标
- [ ] ⛳ `indicators.TechnicalIndicators.calculate_indicators()`  
- [ ] ☑️ `calculate_qvix_percentile()` / `calculate_qvix_daily_change()` / `calculate_impact_cost()`  
- [ ] ☑️ `storage.upsert_indicators()`  
  - 🧾交付物：指标入库快照（CSV 导出）  
  - ✅验收：`pages/05_performance.py` 能读取并展示

### C2 调度
- [ ] ⛳ `scheduler/task_scheduler.py`（APScheduler）  
- [ ] ☑️ `scheduler/premarket_tasks.py::run_premarket_pipeline()`  
- [ ] ☑️ `scheduler/daily_tasks.py::calculate_regime_task()`（可占位）  
- [ ] ☑️ `run_scheduler.py` 注册 premarket/intraday/postmarket/maintenance  
  - 🧾交付物：运行日志（含链路 ID）  
  - ✅验收：执行 `--job premarket` 全流程成功

### C3 可视化
- [ ] 🔗 `pages/05_performance.py` 指标表/QVIX曲线/状态卡  
  - 🧾交付物：1 张历史曲线 + 2 张指标卡  
  - ✅验收：页面无空数据报错

---

## 🧭 大块 D｜Regime 检测（⭐️⭐️⭐️⭐️）
### D1 判定逻辑
- [ ] ⛳ `RegimeState`（六状态）  
- [ ] ⛳ 硬条件：`check_qvix_conditions()` / `check_a50_conditions()` / `check_margin_conditions()`  
- [ ] ⛳ 软条件：`check_soft_conditions()`（阈值来自 `default_params.json/param_schema.json`）  
- [ ] ⛳ 映射与判定：`map_six_states_to_four_regimes()` / `infer_regime()`  
  - 🧾交付物：样例交易日下的判定轨迹 JSON  
  - ✅验收：同日多次运行输出一致（幂等）

### D2 风险可视化
- [ ] 🔗 `pages/04_risk_monitor.py` 当前/历史/触发详情  
  - 🧾交付物：最近 30 日 Regime 变化图  
  - ✅验收：硬/软条件触发能在面板展示

---

## 📦 大块 E｜板块/概念分析 & 关联矩阵 & 生命周期（⭐️⭐️⭐️⭐️）
- [ ] ⛳ `sector_analyzer.analyze_sector()`（行业六步）  
- [ ] ⛳ `concept_analyzer.analyze_concept()`（概念六步）  
- [ ] ⛳ `correlation_matrix.analyze_sector_correlation()`（皮尔逊/斯皮尔曼任选其一起步）  
- [ ] ⛳ `lifecycle_detector.identify_stage()` + `adjust_buy_signal_weights()`  
- [ ] 🔗 `01_overview.py` 热力图；`03_signals.py` 验证结果/生命周期/共振  
  - 🧾交付物：1 张热力图 + 结果表  
  - ✅验收：热力图维度与数据源对齐，无空白块

---

## 🧰 大块 F｜选股与预测信号（⭐️⭐️⭐️⭐️）— **PCR 升级为必做**
### F1 选股
- [ ] ⛳ `stock_selector.calculate_rs_adjusted()/apply_filters()/select_candidates()`（1–5 只）  
  - 🧾交付物：候选池 CSV（含 RS）  
  - ✅验收：每日生成且行数在 1–5

### F2 预测信号（**三路为硬依赖：龙虎榜/ETF/PCR**）
- [ ] ⛳ `predictive_signals.analyze_dragon_tiger_flow()`  
- [ ] ⛳ `predictive_signals.detect_etf_abnormal_flow()`  
- [ ] ⛳ `predictive_signals.calculate_option_pcr()`（分钟级→日级回退）  
- [ ] ⛳ `predictive_signals.aggregate_signals()`（三路聚合得分）  
  - 🧾交付物：分钟/日两级 PCR 产出示例 + 聚合得分表  
  - ✅验收：在 9:10 前三路信号齐全；任一路缺失触发“降级黄灯”日志

### F3 买点生成
- [ ] ⛳ `signal_generator.generate_buy_signals()`（先 2 类买点）  
- [ ] 🔗 前端：`02_stock_selection.py` 候选池/筛选/详情；`03_signals.py` 实时信号/评分/买点分布  
  - 🧾交付物：信号流列表 + 饼图  
  - ✅验收：买点类型分布图非空

---

## ⚖️ 大块 G｜EV 与风控进阶（⭐️⭐️⭐️⭐️⭐️）
- [ ] ⛳ `ev_calculator.calculate_overnight_gap_distribution()/calculate_intraday_drawdown_path()/calculate_time_decay_impact()/calculate_impact_cost()/calculate_path_dependent_ev()`  
- [ ] ⛳ `risk_controller.check_three_red_lines()/check_two_degradation_conditions()/execute_shadow_trading()/trigger_sleep_mode()`  
- [ ] 🔗 `04_risk_monitor.py` 三闸门/红线/影子单/休眠  
  - 🧾交付物：影子单样例 + EV 报表  
  - ✅验收：触发红线后进入休眠并在 UI 高亮

---

## 📊 大块 H｜仓位管理与交易执行（⭐️⭐️⭐️⭐️）
- [ ] ⛳ `portfolio_manager.calculate_kelly_position()/apply_correlation_constraints()/calculate_time_decay_factor()/generate_exit_plan()`  
- [ ] ⛳ `adaptive_weights.update_rs_weights()/evaluate_parameter_performance()`  
- [ ] ⛳ `scheduler/intraday_tasks.py::execute_trading_pipeline()` / `storage.save_trade_record()` / `pages/06_trade_log.py`  
  - 🧾交付物：当日交易明细 + 持仓表 + 盈亏面板  
  - ✅验收：执行状态监控中无失败节点

---

## 📚 大块 I｜绩效分析·样本库·报告（⭐️⭐️⭐️）
- [ ] ⛳ `sample_repository.save_by_regime()/get_regime_samples()/calculate_regime_statistics()`  
- [ ] ⛳ `performance_analyzer.calculate_metrics()`（夏普/回撤等）  
- [ ] ⛳ `report_generator.generate_daily_report()` / `utils/performance_tracker.py` / `utils/notification.py::send_alert()`  
- [ ] 🔗 `pages/05_performance.py` 指标仪表板/资金曲线/分层统计/报告下载  
  - 🧾交付物：日报 PDF/HTML + 报警推送截图  
  - ✅验收：每层 Regime 样本 N≥30；日报可下载；告警可达

---

## 🧩 大块 J｜参数管理 & 参数页面矩阵（⭐️⭐️⭐️）
- [ ] ⛳ `utils/param_manager.py::ParameterManager`（load/save/backup/restore）  
- [ ] ⛳ `config/param_schema.json` / `config/param_history.json` / （可选）`user_params.json`  
- [ ] ⛳ `pages/07_param_config.py … 12_param_manager.py`（切换/回滚/导入导出）  
- [ ] ⛳ **参数追溯**：在参数文件注释“来源自 00 阈值表”；`tools/param_diff.py` 生成差异报告  
  - 🧾交付物：参数编辑 UI + 回滚演示 + diff 报告  
  - ✅验收：任一参数改动可追溯到来源与历史版本

---

## 🛠️ 大块 K｜调度完善 & 维护工具（⭐️⭐️⭐️）
- [ ] ⛳ `postmarket_tasks.reconciliation()/update_sample_repository()/evaluate_parameters()`  
- [ ] ⛳ `maintenance_tasks.backup_database()/cleanup_logs()/generate_weekly_report()`  
- [ ] ⛳ `main.py` 支持 `--web/--scheduler/--all`  
  - 🧾交付物：对账/备份/周报脚本 + 统一入口  
  - ✅验收：非交易日维护任务自动执行、日志正常

---

## 🧪 大块 L｜测试·文档·性能优化（⭐️⭐️⭐️）
### L1 测试
- [ ] ⛳ `test_data_interface.py / test_data_service.py / test_strategy.py / test_risk_control.py / test_database.py / test_predictive_signals.py / test_lifecycle_detector.py / test_correlation_matrix.py / test_adaptive_weights.py`  
  - 🧾交付物：覆盖核心分支与异常路径  
  - ✅验收：关键用例全部通过

### L2 文档
- [ ] ⛳ `docs/user_manual.md / installation_guide.md / strategy_explanation.md / flow_to_api_mapping.md`  
  - 🧾交付物：图文并茂，含“蓝图→标准映射表”  
  - ✅验收：新人按文档可在本地跑通最小链路

### L3 性能
- [ ] ⛳ 索引/缓存/并发/瓶颈排查（基准脚本 + Flamegraph）  
  - 🧾交付物：性能报告（QPS/延迟/CPU/IO）  
  - ✅验收：关键路径达到设定阈值（自定）

---

## 🛡️ 严格对齐 · 提交前自检（必须全部通过）
- [ ] **命名对齐（以《02》为准）**：7/7 `get_*` + `collect_a50_futures/margin` + 概念四口径 `save_concept_*` 均同名存在  
- [ ] **流程映射（《01》为蓝图）**：`docs/flow_to_api_mapping.md` 完整；调度注释引用该表  
- [ ] **阈值对齐（以《00》为源）**：`default_params.json/param_schema.json` 注明来源；`param_diff.py` 报告无缺项  
- [ ] **抽象层红线**：仅 `collector.py` 允许 `import akshare|eastmoney`；pre-commit/CI 检查通过  
- [ ] **配置完整**：`data_source_mapping.json` 覆盖 7/7 接口，含 `primary/fallbacks/retry/rate_limit/cache_ttl/compose`  
- [ ] **质量门**：`system_check.py` 指标“绿色”；数据年龄闸门生效；关键测试全绿

---

### 🔖 个人开发小贴士
- 优先做“⛳可独立交付”的小块；复杂功能先上 🧩占位，保证主干可跑  
- 每完成一小块先产出“🧾交付物”，再按“✅验收”逐条对勾，心态更轻松  
- 任何新增数据需求**先改 mapping**，再补实现；不要破坏抽象层与红线

