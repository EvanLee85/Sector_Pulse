graph TD
    %% ==================== 系统启动 ====================
    A[系统启动 main.py] --> A1{启动模式选择}
    A1 -->|--web| A2[启动Web界面 run_web.py]
    A1 -->|--scheduler| A3[启动定时任务 run_scheduler.py]
    A1 -->|--all| A4[启动完整系统]

    %% all 同时并发启动 调度 + Web，并在调度前加载参数
    A4 --> P0[ParameterManager.load_active_parameters]
    P0 --> B[TaskScheduler.setup_scheduler]
    A4 --> W[Web界面系统]
    A3 --> B
    A2 --> W

    %% 交易日历检查：非交易日走维护分支
    B --> B0{今天是交易日?}
    B0 -->|否| BN[非交易日维护：数据维护/备份/报告]
    BN --> T[生成/分发 报告与归档]
    T --> U[定期数据备份]
    U --> U1[DataStorage.backup_database]
    U1 --> U1_OK{备份成功?}
    U1_OK -->|否| N1[Notification.send_alert → 邮件/微信]
    U1_OK -->|是| U2[ParameterManager.backup_parameters]
    U2 --> V[系统日志归档]
    V --> A4

    B0 -->|是| C[每日8:30 盘前数据采集]

    %% ==================== 盘前采集（8:30）→ 清洗 → 落库 ====================
    C --> C1[DataCollector.collect_market_data]
    C1 --> C2[DataCollector.collect_sector_data]
    C2 --> CC1[DataCollector.collect_concept_data]
    CC1 --> C3[DataCollector.collect_dragon_tiger_data]
    C3 --> C4[DataCollector.collect_fund_flow_data]
    C4 --> C5[DataCollector.collect_qvix_data]
    C5 --> C5A[DataCollector.collect_a50_futures]
    C5A --> C5B[DataCollector.collect_margin_data]
    C5B --> C6[DataCollector.collect_etf_data]

    C6 --> C7[DataCollector.validate_data_quality]
    C7 --> C8{数据质量检查}
    C8 -->|通过| CL1[Cleaner.normalize_and_align]
    C8 -->|失败| C9[重试3次]
    C9 --> C10{仍失败?}
    C10 -->|是| X1[中止主流程：仅复盘/观察]
    C10 -->|否| CL1
    X1 --> T

    %% 清洗与对齐（含行业&概念合并）
    CL1 --> CL2[Cleaner.deduplicate_by_keys]
    CL2 --> CL2A[Cleaner.merge_sector_concept_mapping<br/>行业×概念多重归属合并]
    CL2A --> CL3[Cleaner.align_trading_calendar]

    %% 原始数据分表落库（按类目分别保存，含概念板块）
    CL3 --> Dmkt[DataStorage.save_market_data]
    Dmkt --> Dsec[DataStorage.save_sector_data]
    Dsec --> Dcon1[DataStorage.save_concept_snapshot]
    Dcon1 --> Dcon2[DataStorage.save_concept_constituents]
    Dcon2 --> Dcon3[DataStorage.save_concept_history]
    Dcon3 --> Dcon4[DataStorage.save_concept_history_min]
    Dcon4 --> Ddt[DataStorage.save_dragon_tiger_data]
    Ddt --> Dflow[DataStorage.save_fund_flow_data]
    Dflow --> Dqvix[DataStorage.save_qvix_data]
    Dqvix --> DA50[DataStorage.save_a50_futures]
    DA50 --> DMG[DataStorage.save_margin_data]
    DMG --> Detf[DataStorage.save_etf_flow]

    %% 指标计算与入库（双口径：行业&概念）
    Detf --> D1[TechnicalIndicators.calculate_indicators<br/>含board_type='industry'/'concept']
    D1 --> D1A[calculate_qvix_percentile<br/>滚动计算QVIX分位数]
    D1A --> D1B[calculate_qvix_daily_change<br/>计算QVIX日度变化率]
    D1B --> D2[DataStorage.upsert_indicators]

    %% ==================== 预测信号聚合（9:10）新增 ====================
    D2 --> PS[每日9:10 预测信号聚合]
    PS --> PS1[PredictiveSignals.analyze_dragon_tiger_flow]
    PS1 --> PS2[PredictiveSignals.detect_etf_abnormal_flow]
    PS2 --> PS3[PredictiveSignals.calculate_option_pcr]
    PS3 --> PS4[PredictiveSignals.aggregate_signals]

    %% ==================== Regime 状态识别（9:15） ====================
    PS4 --> E[每日9:15 Regime识别]
    E --> E1[RegimeDetector.check_hard_conditions]
    E1 --> E1A[check_qvix_conditions<br/>QVIX≥90分位 OR 日涨≥+15%]
    E1A --> E1B[check_a50_conditions<br/>A50夜盘<-1%]
    E1B --> E1C[check_margin_conditions<br/>两融5日增>+4% AND 两融/流通>8%]
    E1C --> E2[RegimeDetector.check_soft_conditions]
    E2 --> E3[RegimeDetector.determine_regime_state<br/>六状态→四段位映射]
    E3 --> E3A{六状态判定}
    E3A -->|BULL_ACC/STA| E4A[映射为：进攻段位]
    E3A -->|NEUT_UP| E4B[映射为：标准段位]
    E3A -->|NEUT_DOWN/BEAR_REB| E4C[映射为：防守段位]
    E3A -->|BEAR_DEC| E4D[映射为：休眠段位]
    
    E4A --> E5[仓位上限 = ParameterManager.max_pos_favorable]
    E4B --> E6[仓位上限 = ParameterManager.max_pos_neutral]
    E4C --> E7[仓位上限 = ParameterManager.max_pos_defensive]
    E4D --> E8[禁新仓，仅减风险]

    E5 --> F[RegimeDetector.save_regime_history]
    E6 --> F
    E7 --> F
    E8 --> R[RiskController.execute_circuit_breaker]

    %% ==================== 板块轮动分析（9:20）行业&概念双维度 ====================
    F --> G[每日9:20 板块轮动分析]
    G --> G0{板块分析类型}
    
    %% 行业板块分析分支
    G0 -->|行业| G1S[SectorAnalyzer.six_step_verification]
    G1S --> G2S[SectorAnalyzer.check_strength_comparison]
    G2S --> G3S[SectorAnalyzer.check_breadth_layering]
    G3S --> G4S[SectorAnalyzer.check_time_continuity]
    G4S --> G5S[SectorAnalyzer.check_fund_ratio]
    G5S --> G6S[SectorAnalyzer.check_main_endorsement]
    G6S --> G7S[SectorAnalyzer.check_etf_flow]
    G7S --> G8S{≥5步验证通过?}
    
    %% 概念板块分析分支
    G0 -->|概念| G1C[ConceptAnalyzer.six_step_verification]
    G1C --> G2C[ConceptAnalyzer.check_strength_comparison]
    G2C --> G3C[ConceptAnalyzer.check_breadth_layering]
    G3C --> G4C[ConceptAnalyzer.check_time_continuity]
    G4C --> G5C[ConceptAnalyzer.check_fund_ratio]
    G5C --> G6C[ConceptAnalyzer.check_main_endorsement]
    G6C --> G7C[ConceptAnalyzer.check_etf_flow]
    G7C --> G8C{≥5步验证通过?}
    
    %% 板块关联矩阵分析
    G8S -->|是| GCM[CorrelationMatrix.analyze_sector_correlation<br/>识别共振放大/跷跷板效应]
    G8C -->|是| GCM
    GCM --> G9[热点板块候选清单<br/>行业&概念双维度]
    
    G8S -->|否| G10[记录未通过原因，仅观察]
    G8C -->|否| G10
    G10 --> G10_END[等待下一轮分析]

    %% ==================== 板块生命周期判定（9:22）新增 ====================
    G9 --> LC[板块生命周期判定]
    LC --> LC1[LifecycleDetector.identify_stage<br/>萌芽期/爆发期/成熟期]
    LC1 --> LC2[LifecycleDetector.adjust_buy_signal_weights<br/>动态调整四类买点权重]

    %% ==================== 股票筛选（9:25） ====================
    LC2 --> I[每日9:25 股票筛选]
    I --> I1[StockSelector.identify_first_tier_leader]
    I1 --> I2{一线龙头≥3板?}
    I2 -->|是| I3[警示后周期，禁首次介入二线]
    I2 -->|否| I4[StockSelector.four_layer_funnel_screening]
    I4 --> I5[StockSelector.calculate_rs_adjusted<br/>RS_adjusted = RS_price×W1 + RS_volume×W2 + RS_fund×W3]
    I5 --> I6[StockSelector.liquidity_screening<br/>含流动性冲击成本估算]
    I6 --> I7[StockSelector.fundamental_screening]
    I7 --> I8[StockSelector.technical_confirmation]
    I8 --> I9[StockSelector.get_daily_candidates]
    I9 --> J[候选股票列表 1-5只]
    I3 --> I3_END[仅观察，不开新仓]

    %% ==================== 盘中信号检测（9:30-15:00 每5分钟） ====================
    J --> K[盘中9:30-15:00 每5分钟信号检测]
    K --> K1[SignalGenerator.detect_four_buy_signals<br/>权重已由生命周期调整]
    K1 --> K2[SignalGenerator.check_intraday_indicators]
    K2 --> K3[SignalGenerator.check_sector_synchronization<br/>含concept同步性检查]
    K3 --> K4{买点信号确认?}
    K4 -->|否| K5[NO-GO 继续跟踪]
    K4 -->|是| L[EVCalculator.calculate_pattern_parameters]
    K5 --> K

    %% ==================== EV 量化评估（统一闸门） ====================
    L --> L1[EVCalculator.calculate_path_dependent_ev<br/>含隔夜跳空/盘中回撤/时间衰减]
    L1 --> L1A[EVCalculator.calculate_impact_cost<br/>流动性冲击成本]
    L1A --> L2[EVCalculator.monte_carlo_simulation]
    L2 --> L3[EVCalculator.validate_ev_threshold]
    L3 --> L4{RR / Pwin / EV 达标?}
    L4 -->|否| L5[不下单，记录原因]
    L4 -->|是| M[通过量化闸门]
    L5 --> K

    %% ==================== 风控检查 ====================
    M --> M1[RiskController.check_sop_red_lines<br/>三条红线+两条退化判定]
    M1 --> M2{三条红线检查}
    M2 -->|触发红线| M3[RiskController.execute_circuit_breaker]
    M2 -->|通过| N[PortfolioManager.calculate_kelly_position]
    M3 --> R

    %% ==================== 仓位管理与执行 ====================
    N --> N1A[PortfolioManager.check_correlation_risk]
    N1A --> N2[PortfolioManager.generate_exit_script]
    N2 --> N2A[PortfolioManager.calculate_time_decay_factor<br/>T+1:100% → T+2:90% → T+3:70% → T+4:50%]
    N2A --> O[下单执行]
    %% 执行后即时落库与日志
    O --> TR1[DataStorage.save_trade_record]
    TR1 --> TR2[Logger.log_trade_action]
    TR2 --> O1[PortfolioManager.get_current_portfolio_status]

    %% ==================== 盘中监控 + 实时绩效埋点 ====================
    O1 --> PT[PerformanceTracker.record_realtime_metrics]
    PT --> P[盘中持续监控]
    P --> P1[PortfolioManager.calculate_deviation_degree]
    P1 --> P2{偏离度检查}
    P2 -->|>1.0 严重偏离| P3[考虑止损]
    P2 -->|正常范围| P4[PortfolioManager.calculate_profit_pullback_trigger]

    P4 --> P5{利润回撤触发?}
    P5 -->|浮盈3-8%回撤>30%| P6[减仓操作]
    P5 -->|浮盈>8%回撤>20%| P6
    P5 -->|未触发| P7[继续持有]

    P3 --> P8[执行止损清仓]
    P6 --> P7
    
    %% 时间价值衰减管理
    P7 --> P9A{持仓时间检查}
    P9A -->|T+1| P9B[容忍度100%]
    P9A -->|T+2| P9C[容忍度90%，考虑减仓]
    P9A -->|T+3| P9D[容忍度70%，优先减仓]
    P9A -->|T+4| P9E[容忍度50%，强烈减仓]
    P9A -->|T+5| P10[强制平仓]
    
    P9B --> P
    P9C --> P
    P9D --> P
    P9E --> P
    P8 --> P
    P10 --> P

    %% ==================== 风控熔断处理 ====================
    R --> R1{熔断级别判定}
    R1 -->|黄色 单日-1.5%| R2[减仓30%]
    R1 -->|橙色 单日-2.5%| R3[减仓60%]
    R1 -->|红色 单日-4%| R4[全部清仓]
    R1 -->|QVIX≥90分位 OR 日涨≥+15%| R5[系统休眠]
    R2 --> R6[RiskController.generate_risk_report]
    R3 --> R6
    R4 --> R6
    R5 --> R7[停止所有交易，仅复盘]
    R6 --> N1

    %% ==================== 盘后复盘（15:30） ====================
    P --> S[每日15:30 盘后复盘]
    S --> S1[执行对账：实际 vs 预期]
    S1 --> S2[更新分层样本库<br/>按Regime分层，N≥30/层]
    S2 --> S3[策略表现统计]
    S3 --> S4[AdaptiveWeights.update_parameters<br/>参数权重自适应更新]
    S4 --> S5{需要调整参数?}
    S5 -->|是| S6[记录ADR决策，更新规则]
    S5 -->|否| S7[维持现状]
    S6 --> T
    S7 --> T

    %% ==================== Web 界面系统（支持行业/概念切换） ====================
    W --> W1[Dashboard主控制台<br/>支持board_type切换]
    W1 --> W2[实时显示Regime状态]
    W2 --> W3[显示候选股票列表<br/>行业&概念双维度]
    W3 --> W4[风控红线状态监控]
    W4 --> W5[组合持仓概览]
    W --> W6[参数管理页面]
    W6 --> W7[ParameterManager.load_user_params]
    W7 --> W8[可视化参数调整界面]
    W8 --> W9[ParameterManager.save_parameter_set]
    W9 --> W10[参数集管理：保存/加载/删除]
    W10 --> W11[一键恢复默认参数]
    
    %% Web界面的行业/概念切换功能
    W1 --> WB1[01_overview.py<br/>行业&概念联动视图]
    WB1 --> WB2[时间窗切换]
    WB2 --> WB3[板块排行榜<br/>热力图展示]

    %% ==================== 异常处理与通知（关键事件） ====================
    C9 --> N1
    M3 --> N1
    R5 --> N1
    E1A --> N1
    E1B --> N1
    E1C --> N1

    %% ==================== 循环回到下一个交易日 ====================
    V --> A4
    R7 --> A4
    T --> A4