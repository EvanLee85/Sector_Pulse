# 02. 项目文件结构（对齐 00《V2.3.1》 & 01《流程图 v3.3》） 🧭✨

> 目标：目录、命名与职责与策略/流程图一致；所有关键调用可落位与追溯。  
> 约定：类 `PascalCase`、函数 `snake_case`；存储写入统一 `save_*`，指标入库统一 `upsert_indicators`；通知统一 `Notification.send_alert()`；参数统一 `ParameterManager.*`。

---

## 一、目录树（总览）🌳

```
short_second_strategy v2.3.1/  
│  
├── 📘 README.md  
├── 📦 requirements.txt  
├── 🚀 main.py — 启动入口：--web / --scheduler / --all  
├── ⏱️ run_scheduler.py — 调度启动  
├── 🌐 run_web.py — Web 启动（Streamlit）  
│  
├── 📊 data/  
│   ├── 💾 trading_system.db  
│   ├── 🧰 cache/  
│   │   ├── 📄 daily_cache.json  
│   │   ├── 📄 indicators_cache.pkl  
│   │   ├── 📄 sector_cache.json  
│   │   └── 📄 qvix_percentile_cache.pkl 🆕  
│   └── 🗃️ backups/  
│       ├── 🧯 db_backup_YYYYMMDD.db  
│       └── 🧯 params_backup_YYYYMMDD.json  
│  
├── ⚙️ config/  
│   ├── 🧩 settings.py — logging/database/akshare/scheduler/web/notification 
│   ├── 🗺️ data_source_mapping.json — 🆕 数据源映射配置文件的作用 - 连接抽象接口和具体API
│   ├── 🫙 default_params.json — 默认阈值（RR/Pwin/EV）、段位、仓位上限等  
│   ├── 🫙 user_params.json — 用户参数集（可多套）  
│   ├── 📐 param_schema.json — 参数结构/校验规则  
│   ├── 🧾 param_history.json — 参数版本/回滚  
│   ├── 🗄️ database_schema.sql — DB 表结构（含概念板块相关表）  
│   ├── 🔔 notification.yaml — 通知渠道（邮件/企微/钉钉…）  
│   └── 🔐 secrets.env — 私密凭据  
│  
├── 🛰️ data_service/
│   ├── 🧳 __init__.py
│   ├── 📥 collector.py ✅ — 采集：market/sector/concept/dragon_tiger/fund_flow/qvix/etf/a50/margin
│   │   └── # collect_a50_futures() / collect_margin_data() 🆕
│   ├── 💽 storage.py ✅ — 分表入库/指标入库/交易记录/备份
│   │   └── # save_a50_futures() / save_margin_data() 🆕
│   ├── 🧹 cleaner.py ✅ — 标准化/去重/交易日历对齐/异常标记（含行业&概念口径合并）
│   ├── 📈 market_data.py — 行情数据加工/聚合
│   ├── 💸 fund_flow.py — 资金流与北向资金处理
│   ├── 🧱 sector_data.py — 行业板块：快照/成分/历史/分钟级处理
│   ├── 🧩 concept_data.py — 概念板块：快照/成分/历史/分钟级处理
│   └── 📊 indicators.py ✅ — 技术指标计算
│       └── # calculate_qvix_percentile() / calculate_qvix_daily_change() 🆕
│       └── # calculate_impact_cost() 🆕
│  
├── 🧠 strategy/  
│   ├── 🧳 __init__.py  
│   ├── 🧭 regime_detector.py ✅ — 段位：进攻/标准/防守/休眠
│   │   └── # 六状态枚举：BULL_ACC/STA/NEUT_UP/DOWN/BEAR_REB/DEC 🆕
│   │   └── # map_six_states_to_four_regimes() 🆕
│   │   └── # check_qvix_conditions() / check_a50_conditions() / check_margin_conditions() 🆕
│   ├── 🧪 sector_analyzer.py ✅ — 行业板块六步验证（≥5 步通过）  
│   ├── 🧪 concept_analyzer.py ✅ — 概念板块六步验证（≥5 步通过）
│   ├── 📊 correlation_matrix.py 🆕 — 板块关联矩阵分析
│   │   └── # analyze_sector_correlation() — 识别共振放大/跷跷板效应
│   │   └── # calculate_logic_chain_strength() — 逻辑链强度评分(1.0/0.7/0.3)
│   ├── 🔄 lifecycle_detector.py 🆕 — 板块生命周期判定
│   │   └── # identify_stage() — 萌芽期/爆发期/成熟期
│   │   └── # adjust_buy_signal_weights() — 动态调整四类买点权重
│   ├── 🔮 predictive_signals.py 🆕 — 预测信号聚合
│   │   └── # analyze_dragon_tiger_flow() — 龙虎榜资金迁移(领先1-2日)
│   │   └── # detect_etf_abnormal_flow() — ETF异动申赎(0.5-1日)
│   │   └── # calculate_option_pcr() — 期权PCR变化(同步确认)
│   │   └── # aggregate_signals() — 信号综合评分
│   ├── 🎯 stock_selector.py ✅ — 一线确认 + 二线四层漏斗（1–5 只）
│   │   └── # calculate_rs_adjusted() — RS_adjusted = RS_price×W1 + RS_volume×W2 + RS_fund×W3 🆕
│   ├── 📡 signal_generator.py ✅ — 四类买点（突破/回踩/趋势/反包）  
│   ├── 🎲 ev_calculator.py ✅ — 路径依赖 EV + Monte Carlo（统一三闸门）
│   │   └── # calculate_overnight_gap_distribution() 🆕
│   │   └── # calculate_intraday_drawdown_path() 🆕
│   │   └── # calculate_time_decay_impact() 🆕
│   │   └── # calculate_impact_cost() — 流动性冲击成本 🆕
│   ├── 🛡️ risk_controller.py ✅ — SOP 红线/熔断/休眠
│   │   └── # check_three_red_lines() — 月回撤/QVIX/流动性 🆕
│   │   └── # check_two_degradation_conditions() — EV_net/胜率 🆕
│   │   └── # execute_shadow_trading() — 影子单机制 🆕
│   ├── 📊 portfolio_manager.py ✅ — Kelly 仓位/相关性约束/卖出剧本（含 T+5）
│   │   └── # calculate_time_decay_factor() — T+1:100% → T+2:90% → T+3:70% → T+4:50% 🆕
│   └── ⚖️ adaptive_weights.py 🆕 — 参数权重自适应
│       └── # update_rs_weights() — 根据Regime调整RS权重
│       └── # update_buy_signal_weights() — 根据生命周期调整买点权重
│       └── # evaluate_parameter_performance() — 参数表现评估
│  
├── 🖥️ web_interface/  
│   ├── 🧳 __init__.py  
│   ├── 🏠 dashboard.py — 总览（Regime/候选/风控/持仓/绩效；行业/概念切换）
│   ├── 📄 pages/  
│   │   ├── 01_overview.py（"行业 & 概念"联动视图、时间窗切换、排行）  
│   │   ├── 02_stock_selection.py  
│   │   ├── 03_signals.py  
│   │   ├── 04_risk_monitor.py  
│   │   ├── 05_performance.py  
│   │   ├── 06_trade_log.py  
│   │   ├── 07_param_config.py（参数可视化/保存）  
│   │   ├── 08_param_risk.py  
│   │   ├── 09_param_strategy.py  
│   │   ├── 10_param_quant.py  
│   │   ├── 11_param_system.py  
│   │   └── 12_param_manager.py  
│   ├── 🧩 components/ — charts.py | tables.py | alerts.py | metrics.py | widgets.py  
│   │   └── （组件统一支持 board_type={'industry','concept'} 以在两套口径下复用）
│   └── 🧰 utils/ — session_state.py | layout_helper.py | data_formatter.py  
│  
├── 🧰 utils/  
│   ├── 🧳 __init__.py  
│   ├── 📝 logger.py ✅ — StrategyLogger / log_trade_action / 轮转  
│   ├── 🧭 helpers.py ✅ — 交易日历/时间窗/工具  
│   ├── 🧯 param_manager.py ✅ — ParameterManager.load_active_parameters / backup_parameters / save_parameter_set  
│   ├── 📈 performance_tracker.py ✅ — 盘中/日度绩效埋点与阈值监控  
│   ├── 🔔 notification.py ✅ — Notification.send_alert(event, level, message, channels)  
│   └── 🗃️ database_manager.py ✅ — 连接/WAL/备份/恢复/健康  
│  
├── 🗓️ scheduler/  
│   ├── 🧳 __init__.py  
│   ├── ⏰ task_scheduler.py ✅ — APScheduler；交易日历判断与任务编排  
│   ├── 🌅 premarket_tasks.py ✅ — 盘前：采集（sector+concept+a50+margin）→ 清洗 → 分表落库 → 指标 → upsert  
│   ├── 🕘 intraday_tasks.py ✅ — 盘中：信号 → EV → 风控 → 仓位 → 执行 → 绩效埋点  
│   ├── 🌆 postmarket_tasks.py ✅ — 盘后：对账/分层样本库/参数评估/报告  
│   ├── 📆 daily_tasks.py — 日常/通用任务  
│   └── 🧺 maintenance_tasks.py ✅ — 非交易日：数据维护/备份/报告  
│  
├── 🔬 analysis/  
│   ├── 🧳 __init__.py  
│   ├── 🧪 backtest_engine.py ✅  
│   ├── 📊 performance_analyzer.py ✅  
│   ├── 🔍 trade_analyzer.py ✅  
│   ├── 📉 drawdown_analyzer.py ✅  
│   ├── 📄 report_generator.py ✅  
│   └── 🗂️ sample_repository.py 🆕 — 分层样本库管理
│       └── # save_by_regime() — 按Regime分层存储(N≥30/层)
│       └── # get_regime_samples() — 获取特定Regime样本
│       └── # calculate_regime_statistics() — 分层统计分析
│  
├── 🧾 logs/  
│   ├── 📅 daily/ — app/trade/data/error_YYYYMMDD.log  
│   ├── 🎛️ strategy/ — signals.log / risk_events.log / param_changes.log  
│   ├── 🔔 notifications.log  
│   ├── 🌐 web/ — streamlit.log  
│   └── 🛠️ system/ — scheduler.log / performance.log  
│  
├── 📚 docs/  
│   ├── user_manual.md | api_docs.md | installation_guide.md | database_guide.md | strategy_explanation.md  
│   └── 🗺️ workflow_diagram.mmd — 与 01 流程图 v3.3 同步  
│  
├── 🧪 tests/  
│   ├── test_data_service.py | test_strategy.py | test_risk_control.py | test_web_interface.py  
│   ├── test_database.py | test_utils.py | test_notification.py | test_param_manager.py  
│   ├── test_predictive_signals.py 🆕  
│   ├── test_lifecycle_detector.py 🆕  
│   ├── test_correlation_matrix.py 🆕  
│   ├── test_adaptive_weights.py 🆕  
│   └── 🧭 conftest.py  
│  
├── 🔧 scripts/  
│   ├── 🚀 start_system.py | ⏹️ stop_system.py | 🗄️ init_database.py  
│   ├── 💾 backup_data.py | 🔄 restore_data.py | 🧹 cleanup.py  
│   ├── 📊 generate_report.py | 🧪 system_check.py | 🕰️ import_historical_data.py  
│  
└── 🛠️ tools/  
    ├── data_importer.py | param_optimizer.py | strategy_tester.py  
    └── log_analyzer.py | database_tools.py  
```

---

## 二、数据接口抽象层设计 🔌

### 设计原则
- **接口稳定**：文档中的函数名保持不变，避免因数据源变化反复修改文档
- **实现灵活**：具体akshare API调用可在实现时调整，支持多数据源
- **配置驱动**：新增数据需求通过配置文件管理，实现热更新

### 数据接口约定
- 所有数据获取都通过统一抽象接口，具体API映射在配置文件中定义：

```python
class DataCollector:
    # === 核心稳定接口（文档中固定，不轻易变更） ===
    def get_basic_market_data() -> Dict      # 基础行情数据
    def get_sector_data() -> Dict            # 板块数据（行业+概念）
    def get_correlation_data() -> Dict       # 相关性数据（计算得出）
    def get_fund_flow_data() -> Dict         # 资金流数据
    def get_risk_indicator_data() -> Dict    # 风险指标数据（QVIX、A50、两融）
    def get_dragon_tiger_data() -> Dict      # 龙虎榜数据
    def get_etf_flow_data() -> Dict          # ETF申赎数据
    
    # === 扩展接口（通过配置文件动态管理） ===
    def get_extended_data(data_type: str) -> Dict  # 通用扩展接口
    # 具体扩展类型在 data_source_mapping.json 的 "extensions" 节点中定义
```

### 配置文件说明
- **🔗 data_source_mapping.json**：API映射配置，支持多数据源、缓存策略、失败重试
- **扩展点预留**：支持未来接入Wind、Choice等其他数据源
- **🔧 主要组成部分**
    核心接口映射 - 7个稳定的数据接口，覆盖策略的主要数据需求
    扩展接口 - 预留未来可能需要的数据源（期权、期货、情绪等）
    容错机制 - 重试、缓存、熔断器等
    缓存策略 - 分层缓存，提高性能
    限流控制 - 避免API调用过频
    数据质量 - 数据验证和异常检测
    备用数据源 - Wind、Choice等商业数据源预留
    监控告警 - 健康检查和性能监控
    开发支持 - 测试模式、Mock数据等
- **✅ 设计亮点**
    向前兼容 - 核心接口稳定，扩展通过配置管理
    生产就绪 - 包含完整的监控、容错、限流机制
    可维护性 - 配置化管理，避免硬编码
    扩展性 - 预留多种扩展点，支持未来需求

### 数据需求变更流程（免疫机制）
1. **需求评估**：确定数据接口名称（抽象层面）
2. **配置更新**：在data_source_mapping.json中添加API映射
3. **实现迭代**：在具体代码中实现，不影响文档架构
4. **文档稳定**：三个核心文档保持不变

这样设计确保了文档的稳定性，避免因数据源频繁变化而反复修改核心架构文档。

---

## 三、关键文件说明 🧷

### 1) 启动文件（与流程图 A/B/W 匹配）🟢
- **🚀 main.py**：解析 `--web | --scheduler | --all`；`--all` 并发 Web + Scheduler；调度前先 `ParameterManager.load_active_parameters()`；关键日志落 `logs/system/scheduler.log`。  
- **⏱️ run_scheduler.py**：初始化 APScheduler；注册 `premarket / intraday / postmarket / maintenance`；按交易日历切分路径。  
- **🌐 run_web.py**：启动 Streamlit；注册总览与参数页；提供参数加载/保存入口。

### 2) 配置管理（与 00/01 参数来源一致）🧩
- **⚙️ config/settings.py**：统一键域 `logging / database / akshare / scheduler / web / notification / paths`。  
- **🫙 参数文件**：`default_params.json / user_params.json / param_schema.json / param_history.json`。  
- **🔔 通知/凭据**：`notification.yaml`；`secrets.env`。  
- **🗄️ 数据库**：`database_schema.sql` 含概念板块相关表（snapshot / constituents / history / history_min）。

### 3) 用户参数采集（对应流程图 W6–W11）🧑‍💻
- `07_param_config.py` 及分域参数页展示/编辑/校验；  
- `ParameterManager.save_parameter_set()` / `load_user_params()`；  
- `ParameterManager.backup_parameters()`（启动/非交易日）；  
- 保存即校验（schema + 风险阈值）。

### 4) 核心模块职责（与流程节点对表）🧩

#### 🛰️ **data_service** 
- `collector.py`：盘前采集 market / sector / concept / dragon_tiger / fund_flow / qvix / etf / **a50 / margin**
- `cleaner.py`：normalize → deduplicate → align_trading_calendar；合并行业&概念多重归属
- `storage.py`：
  - 分表入库：含 `save_a50_futures()` / `save_margin_data()`
  - 指标入库：`upsert_indicators`
  - 交易记录：`save_trade_record`
  - 备份：`backup_database`（失败触发 `Notification.send_alert`）
- `indicators.py`：
  - **新增**：`calculate_qvix_percentile()` — 滚动计算QVIX分位数
  - **新增**：`calculate_qvix_daily_change()` — 计算日度变化率
  - **新增**：`calculate_impact_cost()` — 流动性冲击成本

#### 🧠 **strategy**
- `regime_detector.py`：
  - **新增六状态枚举**：BULL_ACC/STA、NEUT_UP/DOWN、BEAR_REB/DEC
  - **新增映射函数**：`map_six_states_to_four_regimes()`
  - **新增硬条件检查**：`check_qvix_conditions()` / `check_a50_conditions()` / `check_margin_conditions()`
- **新增文件**：
  - `correlation_matrix.py`：板块关联矩阵，识别共振/跷跷板
  - `lifecycle_detector.py`：板块生命周期判定与买点权重调整
  - `predictive_signals.py`：预测信号聚合（龙虎榜/ETF/期权）
  - `adaptive_weights.py`：参数权重自适应更新
- `stock_selector.py`：
  - **新增**：`calculate_rs_adjusted()` — RS动态排序公式
- `ev_calculator.py`：
  - **新增路径依赖要素**：隔夜跳空分布、盘中回撤路径、时间衰减、流动性冲击
- `risk_controller.py`：
  - **新增SOP机制**：三条红线检查、两条退化判定、影子单机制
- `portfolio_manager.py`：
  - **新增**：`calculate_time_decay_factor()` — T+1到T+5容忍度递减

#### 🗓️ **scheduler**
- 盘前：collector（sector+concept+**a50+margin**） → cleaner → storage.save_* → indicators（含**QVIX分位计算**） → storage.upsert_indicators
- **新增9:10**：predictive_signals聚合
- 盘中：signal → EV（**含所有路径依赖要素**）→ 风控（**含SOP红线**）→ 仓位（**含时间衰减**）→ 执行 → 绩效埋点
- 盘后：对账/**分层样本库**/参数评估（**自适应更新**）/报告

#### 🔬 **analysis**
- **新增**：`sample_repository.py` — 分层样本库管理，按Regime分层存储（N≥30/层）

#### 🧪 **tests**
- **新增测试文件**：
  - `test_predictive_signals.py` — 预测信号测试
  - `test_lifecycle_detector.py` — 生命周期检测测试
  - `test_correlation_matrix.py` — 关联矩阵测试
  - `test_adaptive_weights.py` — 自适应权重测试

---

## 四、目录组织原则 🧱
- **🔤 命名统一**：`save_* / upsert_indicators / ParameterManager.* / Notification.send_alert()`；流程图出现的方法名需在代码或文档中落位映射。  
- **🧭 边界清晰**：仅 `storage.py` 直接写 DB；外部数据访问由 `data_service/*` 统一负责。  
- **🪪 可观测性**：日志分层；下单后即时 `save_trade_record + log_trade_action + record_realtime_metrics`。  
- **🧰 配置与环境**：凭据仅 `secrets.env`；通道/收件人/阈值在 `notification.yaml`。  
- **🧪 测试与质量**：采集/清洗/落库/指标/EV/风控/仓位/执行/通知/参数等关键路径全覆盖；DB 迁移/备份/恢复具备集成测试。

---

## 五、模块间调用关系（与流程图对表）🔗
```
main.py
→ scheduler/task_scheduler.py（交易日历判断）  
→ premarket_tasks.py：
  - collector（sector+concept+a50+margin） 
  - → cleaner 
  - → storage.save_* 
  - → indicators.calculate_indicators + calculate_qvix_percentile + calculate_qvix_daily_change
  - → storage.upsert_indicators
→ 9:10 predictive_signals.py（预测信号聚合）  
→ 9:15 regime_detector.py（六状态→四段位映射，含QVIX/A50/两融检查）  
→ 9:20 sector_analyzer.py & concept_analyzer.py → correlation_matrix.py  
→ 9:22 lifecycle_detector.py（板块生命周期→买点权重）  
→ 9:25 stock_selector.py（含RS_adjusted动态排序）  
→ 盘中 intraday_tasks.py：
  - signal_generator（权重已调整）
  - → ev_calculator（路径依赖+冲击成本）
  - → risk_controller（SOP三条红线）
  - → portfolio_manager（Kelly+时间衰减）
  - → storage.save_trade_record 
  - → performance_tracker
→ 盘后 postmarket_tasks.py：
  - 对账
  - → sample_repository（分层存储）
  - → adaptive_weights（参数自适应）
  - → analysis/report_generator.py
→ 非交易日 maintenance_tasks.py：backup_database → Notification.send_alert(失败) + 报告/归档
```

---

## 六、对齐核对清单（PR 自检 ✅）📋
- [x] **QVIX双重判断**：分位数阈值 + 日度变化率，相关计算方法已在 `indicators.py` 中定义
- [x] **六状态→四段位映射**：`regime_detector.py` 包含完整映射逻辑
- [x] **板块生命周期**：新增 `lifecycle_detector.py` 处理阶段判定与权重调整
- [x] **RS动态排序**：`stock_selector.py` 包含 `calculate_rs_adjusted()` 方法
- [x] **SOP刹车系统**：`risk_controller.py` 实现三条红线、两条退化、影子单
- [x] **路径依赖EV要素**：`ev_calculator.py` 包含所有计算要素
- [x] **时间价值衰减**：`portfolio_manager.py` 实现T+1到T+5递减管理
- [x] **预测信号模块**：新增 `predictive_signals.py` 处理多种预测信号
- [x] **板块关联矩阵**：新增 `correlation_matrix.py` 识别板块关系
- [x] **样本库分层**：新增 `sample_repository.py` 按Regime分层管理
- [x] **参数自适应**：新增 `adaptive_weights.py` 动态更新权重
- [x] **流动性冲击成本**：在 `indicators.py` 和 `ev_calculator.py` 中实现
- [x] **A50/两融数据**：`collector.py` 和 `storage.py` 支持相关数据采集存储
- [x] **版本号对齐**：文档已更新为对齐 v3.3