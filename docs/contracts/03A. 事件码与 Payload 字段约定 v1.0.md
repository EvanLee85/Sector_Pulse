# 03A. 事件码与 Payload 字段约定 v1.0
**范围**：SectorPulse · 步骤2「盘中情绪闸门（Alt-Flow）」产生与依赖的事件  
**适用对象**：策略调度、数据采集、风控回放、观测面（Dashboard / 日志查询）  
**版本**：v1.0（与《03. 指标数据契约（步骤2 · Alt-Flow）v1.1》、`config/indicators_contract.yaml@step2-contract-v1.1` 对齐）  
**时间/时区**：所有事件时间采用 ISO8601（带偏移）+ `Asia/Shanghai` 时区

---

## 0. 事件记录通用封装（EventLog）
- 表结构：`ts | level | code | payload_json`
- `ts`：事件写入时间（ISO8601，+08:00）
- `level`：`INFO | WARN | ERROR`
- `code`：事件码（见下文）
- `payload_json`：JSON 对象，**必须**遵守相应事件的“必填/可选”字段约定

---

## 1. 事件码一览
按场景分为三组；本文件重点定义 Alt-Flow 判定的两类事件，其他为依赖与上下游事件（用于成链追踪）。

### A) Alt-Flow 判定（步骤2产出）
- `altflow/gate_pass`  
- `altflow/gate_reject`

### B) 调度生命周期（步骤1已存在，供回放与串联）
- `scheduler_start` / `scheduler_stop`
- `scheduler_tick` / `scheduler_skip`

### C) 交易日历与降级（步骤1已存在，供来源与状态透传）
- `calendar_refresh_ok` / `calendar_use_cache`
- `calendar_fallback_weekday` / `calendar_unavailable`

> 注：B/C 两组**不在本文件重复定义全量字段**，仅保持与步骤1一致；本文只列最小必读字段，确保与 Alt-Flow 事件可串联。

---

## 2. Alt-Flow 事件（核心约定）
两类事件的 Envelope 相同，仅 `passed` 与 `reasons` 内容不同。**所有字段名/类型必须与 03 契约、YAML 完全一致**。

### 2.1 `altflow/gate_pass`
- **level**：`INFO`
- **必填字段（Payload）**  
  | 字段 | 类型 | 说明 |
  |---|---|---|
  | `window` | `string` | 判定窗口：`"10:00"` / `"14:00"` |
  | `tz` | `string` | 固定 `"Asia/Shanghai"` |
  | `passed` | `boolean` | 恒为 `true` |
  | `reasons` | `string[]` | **必须存在**；通过时应为空数组 |
  | `calendar` | `object` | `{source: "akshare"|"cache"|"weekday_fallback"|"unavailable", degraded: boolean, staleness_days: number}` |
  | `sources` | `object` | 指标到实际数据源的映射：`{ <indicator>: { api: string, fetched_at: datetime-iso } }` |
  | `indicators` | `object` | 见《03 契约》§1 的指标全集（含背景项与 flags） |
  | `thresholds` | `object` | 当前判定使用的阈值快照（与配置一致） |
  | `version` | `string` | 固定 `step2-contract-v1.1` |
  | `calc_at` | `datetime` | 指标计算完成时间（+08:00） |
- **取值/范围约束（关键字段）**  
  - `turnover_concentration_top20 ∈ [0,1]`；`vol_percentile ∈ [0,1]`  
  - `limitup_down_ratio ≥ 0`；`sh_above_ma20 ∈ {true,false}`  
  - 两融金额按 **亿元** 记录；`intraday_missing == false`

### 2.2 `altflow/gate_reject`
- **level**：`INFO`（或 `WARN`，当拒绝由“数据缺失/降级触发”时建议 `WARN`）
- **必填字段（Payload）**：与 `altflow/gate_pass` **完全相同**，但：  
  - `passed: false`  
  - `reasons`：**非空**，以“可读字符串”列出失败因子，建议格式：  
    - `"<key>: <actual> vs <threshold> (operator)"`（例如：`vol_percentile: 0.93 vs 0.85 (<=)`）  
    - 存在盘中数据缺失时，必须含 `"intraday_missing"`  
- **常见失败因子键（与 03 契约一致）**  
  - `limit_up_count`、`limitup_down_ratio`、`turnover_concentration_top20`、`vol_percentile`、`sh_above_ma20`、`intraday_missing`

---

## 3. 调度相关事件（最小字段对齐）
> 详细见步骤1文档；此处只列 Alt-Flow 串联所需字段。

### 3.1 `scheduler_start`
- **level**：`INFO`
- **必填（最小集）**：`tz`、`windows`、`jobstore_url`、`preheat_enabled`、`calendar_{source, fail_policy, degraded, staleness_days}`

### 3.2 `scheduler_stop`
- **level**：`INFO`
- **必填（最小集）**：无强制业务字段（用于生命周期闭环）

### 3.3 `scheduler_tick` / `scheduler_skip`
- **level**：`INFO`
- **必填（最小集）**：`window`、`tz`、`action`（`"EXECUTE"` 或 `"SKIP"`）、`calendar_{source, degraded, staleness_days}`  
- **关系**：在 `scheduler_tick@10:00/14:00` 后应出现一条 `altflow/gate_*` 事件（同窗口）

---

## 4. 交易日历事件（最小字段对齐）
### 4.1 `calendar_refresh_ok`
- **level**：`INFO`
- **必填（最小集）**：`source="akshare"`、`fetched_at`、`degraded=false`

### 4.2 `calendar_use_cache`
- **level**：`INFO`
- **必填（最小集）**：`staleness_days`、`degraded`、`cached_at`

### 4.3 `calendar_fallback_weekday`
- **level**：`WARN`
- **必填（最小集）**：`fail_policy="fail_open"`、`degraded=true`

### 4.4 `calendar_unavailable`
- **level**：`ERROR`
- **必填（最小集）**：`fail_policy="fail_closed"`、`degraded=true`

---

## 5. 校验规则（用于实现与测试）
1) **键一致性**：`altflow/gate_*` 的 Payload **必须**同时包含：  
   `window, tz, passed, reasons, calendar, sources, indicators, thresholds, version, calc_at`  
2) **类型与范围**：严格遵守《03 契约 §1/§6》；布尔仅 `true/false`；百分位与占比在 `[0,1]`。  
3) **时区一致性**：`tz == "Asia/Shanghai"`；所有时间字段均带 `+08:00` 偏移。  
4) **幂等**：同窗口重复写入允许，但应保持版本号一致；允许覆盖或追加（由实现约定）。  
5) **串联检查**：每个 `scheduler_tick`（交易日+窗口内）之后，**必须**出现同窗口的 `altflow/gate_*` 事件。  
6) **来源记录**：`sources[*].api` 与 `sources[*].fetched_at` 必填；用于审计与回放。  
7) **降级与缺失**：当 `calendar.degraded == true` 或 `intraday_missing == true` 时，必须在 `reasons` 标明相应原因。

---

## 6. 兼容性与版本
- 本文件 v1.0 与《03 契约 v1.1》、`indicators_contract.yaml@step2-contract-v1.1` **一一对应**；任一字段变更需同步更新三处版本号。  
- 步骤1事件（scheduler*/calendar*）沿用既有定义；如字段扩展，请在步骤1文档更新并在此处补充“最小字段”。

---

## 附录｜Alt-Flow 事件金样本（可用于自动校验）
- 通过样本：`docs/contracts/examples/step2_gate_payload_pass.json`
- 拒绝样本（指标不达标）：`docs/contracts/examples/step2_gate_payload_reject_indicator.json`
- 拒绝样本（盘中数据缺失）：`docs/contracts/examples/step2_gate_payload_reject_intraday_missing.json`

> 使用 `tests/07_test_validate_altflow_payload.py` 对上述样本进行自动校验。
