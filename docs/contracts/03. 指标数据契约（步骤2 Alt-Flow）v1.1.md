# 03. 指标数据契约（步骤2 · Alt-Flow）v1.1
**范围**：SectorPulse「步骤2｜盘中情绪闸门（Alt-Flow 版）」  
**窗口**：仅在 `10:00` / `14:00` 两个时窗进行闸门判定  
**数据源版本**：AkShare **v1.17.40**  
**目的**：统一“指标键名 / 单位 / 计算口径 / 缺失与降级语义 / 事件 payload 结构”，作为实现与测试的唯一依据。  
> 机器可读映射：`config/indicators_contract.yaml`（版本号与本文一致）。

---

## 1. 指标总览（必须字段）
| 键名 | 类型 | 单位 / 取值域 | 时间基准 | 是否必填 | 说明 |
|---|---|---|---|---|---|
| `limit_up_count` | int | 家数 | 盘中 | 是 | 当日实时涨停家数 |
| `limit_down_count` | int | 家数 | 盘中 | 是 | 当日实时跌停家数 |
| `limitup_down_ratio` | float | \[0, +∞) | 盘中 | 是 | `limit_up_count / max(1, limit_down_count)` |
| `turnover_concentration_top20` | float | \[0, 1] | 盘中 | 是 | 全市场**成交额**前20占比 |
| `hs300_vol_30d_annualized` | float | 年化（小数） | 日终 | 是 | HS300 近 30 交易日实现波动（年化） |
| `vol_percentile` | float | \[0, 1] | 日终 | 是 | 上述波动在回溯窗口内的分位 |
| `sh_above_ma20` | bool | True/False | 盘中（昨收 MA20 对当日价） | 是 | 上证是否在 MA20 上方 |
| `margin_net_repay_yi_prev` | float | **亿元** | 上一交易日 EOD | 是 | 两融净买入（+）/净偿还（−），仅记录背景 |
| `intraday_missing` | bool | - | 盘中 | 是 | 盘中数据缺失标志（见 §4） |
| `calendar_degraded` | bool | - | 系统态 | 是 | 交易日历降级标志（见 §4） |
| `window` | str | `10:00` / `14:00` | 系统态 | 是 | 判定窗口戳 |
| `tz` | str | `Asia/Shanghai` | 系统态 | 是 | 统一时区戳 |
| `calc_at` | datetime | ISO8601 +08:00 | 系统态 | 是 | 指标计算时间 |
| `sources` | dict | {key → {api, fetched_at}} | 系统态 | 是 | 各指标命中的接口与抓取时间 |

> 注：**盘中项**（涨跌停比、成交额集中度、MA20 对比）与**结构/波动项**必须齐备；**两融**仅入 `indicators`，不参与当日布尔判定。

---

## 2. 数据口径与来源（首选 → 备用）
**统一约定**：成交额默认=**元**；两融汇总=**亿元**；指数 `volume=手`、`amount=元`。  

### 2.1 涨跌停与涨跌停比
- `limit_up_count`：`stock_zt_pool_em(date)` →（回溯校验）`stock_zt_pool_previous_em(date)` / `stock_zt_pool_strong_em(date)`  
- `limit_down_count`：`stock_zt_pool_dtgc_em(date)`  
- `limitup_down_ratio`：以上二者派生

### 2.2 成交额集中度（拥挤度）
- `turnover_concentration_top20`：  
  首选 `stock_zh_a_spot_em()`；备用 `stock_sh_a_spot_em()` / `stock_sz_a_spot_em()` / `stock_bj_a_spot_em()`；  
  回退复算 `stock_zh_a_hist_min_em(symbol, period)` / `stock_intraday_em(symbol)` / `stock_intraday_sina(symbol, date)`。

### 2.3 指数与波动
- `hs300_vol_30d_annualized`、`vol_percentile`：`stock_zh_index_daily_em(symbol='sh000300' 或 'csi000300')` → 备用 `index_zh_a_hist`  
- `sh_above_ma20`：`stock_zh_index_daily_em(symbol='sh000001')`（算 MA20） + `stock_zh_index_spot_em()` → 备用 `stock_zh_index_spot_sina()`

### 2.4 两融（上一交易日 · 背景）
- `margin_net_repay_yi_prev`：`stock_margin_sse(start_date, end_date)` + `stock_margin_szse(date)`（单位统一为**亿元**）；必要时 `stock_margin_detail_sse` / `stock_margin_detail_szse` 校验；`stock_margin_underlying_info_szse` 仅作元数据参考。

---

## 3. 判定映射（阈值 ↔ 指标）
来自配置（由 `loader.py` 解析）：
- `limit_up_count ≥ limit_up_count_min`
- `limitup_down_ratio ≥ limitup_down_ratio_min`
- `turnover_concentration_top20 ≤ turnover_concentration_max`
- `vol_percentile ≤ vol_percentile_max`
- `ma20_required == True ⇒ sh_above_ma20 == True`

**通过条件**：以上全部满足 **且** `intraday_missing == False` → `passed: true`；否则 `passed: false`。  
**说明**：`margin_net_repay_yi_prev` **不参与**当日通过判定，仅入 `indicators`。

---

## 4. 缺失与降级语义
- `intraday_missing = True`（任一盘中关键数据缺失/超时/异常）→ 当日**直接** `passed: false`；`reasons` 必含 `"intraday_missing"`。  
- `calendar_degraded = True`（日历使用陈旧缓存 / 回退规则）→ **不直接否决**，但需记录在事件 payload。  
- 盘中项回退顺序与命中接口记录在 `sources`（用于排障与审计）。

---

## 5. 事件契约（落库到 `EventLog`）
**事件码**：`altflow/gate_pass` 或 `altflow/gate_reject`  
**payload（必要字段）**：
- `window: str`（`10:00` / `14:00`）  
- `tz: "Asia/Shanghai"`  
- `passed: bool`  
- `reasons: list[str]`（未通过时列出 `"指标名: 实际值 vs 阈值"`；缺失列 `"intraday_missing"`）  
- `indicators: dict`（包含 §1 所有键）  
- `thresholds: dict`（静态快照：`limit_up_count_min / limitup_down_ratio_min / turnover_concentration_max / vol_percentile_max / ma20_required`）  
- `calendar: {source, degraded, staleness_days}`  
- `sources: dict`（各指标的 `{api, fetched_at}`）  
- `version: "step2-contract-v1.1"`
- `calc_at: datetime（ISO8601 +08:00）`
- `规则: “indicators 必须至少包含 §1 表中 required: true 的所有键名。”`

---

## 6. 校验规则（实现与测试共同遵循）
- **类型**：严格按 §1；`float` 为十进制小数；`bool` 为 `True/False`。  
- **单位**：成交额=元、两融=亿元；分母为 0 的比值使用 `max(1, limit_down_count)`。  
- **范围**：`turnover_concentration_top20 ∈ [0,1]`；`vol_percentile ∈ [0,1]`。  
- **窗口**：仅在 `10:00` / `14:00` 调用判定；盘前仅计算背景项。  
- **幂等**：同一窗口多次计算，后写覆盖先写（或追加事件但版本号一致）。  
- **来源记录**：`sources[key].api` 必填；`fetched_at` 为 ISO8601 +08:00。

---

## 7. 实现备注 / 口径说明（新增）
1. **两融单位统一（强约束）**  
   - 上交所与深交所接口的单位可能不同（如“元” vs “亿元/亿股”）。本契约强制将所有两融金额口径统一到 **亿元**；若来源为“元”，需在入库前 `/ 1e8` 转换。`margin_net_repay_yi_prev` 按“亿元”记录。  
   - 仅记录**上一交易日**汇总口径（EOD），用于背景显示与复盘，不参与当日 `passed` 判定。

2. **指数符号与计算口径（固定映射）**  
   - 上证指数固定使用 `sh000001`；沪深300固定使用 `sh000300`（若环境仅提供 `csi000300`，视为等价替代）。  
   - `sh_above_ma20` 的 MA20 以**日线收盘价**计算（不使用未来信息），窗口判定时以**当前实时价**对比“昨收MA20”，避免前视偏差。  
   - `hs300_vol_30d_annualized` 与 `vol_percentile` 基于 HS300 **日线收盘序列**，回溯样本建议 ≥252 交易日。

3. **盘中数据与窗口时效 / 回退（强约束）**  
   - 盘中三项首选来源：涨停池 `stock_zt_pool_em`、跌停池 `stock_zt_pool_dtgc_em`、全市场快照 `stock_zh_a_spot_em`；仅在 `10:00` 与 `14:00` 执行判定。  
   - 分钟线 `stock_zh_a_hist_min_em` 的 **1分钟粒度仅近 5 个交易日有效**；当首选来源异常时可回退复算，并在 `sources` 标注回退来源；若仍缺失则置 `intraday_missing=True` 并 `passed=False`。  
   - 实时指数建议双源容灾（东财/新浪），以东财为首选；两源差异不触发否决，但需记录实际命中源。

---

## 8. 版本与变更
- **当前版本**：`step2-contract-v1.1`（AkShare v1.17.40）  
- **v1.1 变更**：新增 §7「实现备注 / 口径说明」；明确两融单位统一=亿元、指数符号固定映射与 MA20/波动口径、分钟线近 5 日有效与回退策略。  
- **v1.0 → v1.1 兼容性**：仅补充说明，无结构变更；事件与指标字段不变。

---

## 9. 附录：接口覆盖（21/21）
1. `stock_zt_pool_em`　2. `stock_zt_pool_previous_em`　3. `stock_zt_pool_strong_em`　4. `stock_zt_pool_dtgc_em`  
5. `stock_zh_a_spot_em`　6. `stock_sh_a_spot_em`　7. `stock_sz_a_spot_em`　8. `stock_bj_a_spot_em`  
9. `stock_zh_a_hist_min_em`　10. `stock_intraday_em`　11. `stock_intraday_sina`　12. `stock_zh_a_hist_pre_min_em`  
13. `stock_zh_index_daily_em`　14. `index_zh_a_hist`　15. `stock_zh_index_spot_em`　16. `stock_zh_index_spot_sina`  
17. `stock_margin_sse`　18. `stock_margin_detail_sse`　19. `stock_margin_szse`　20. `stock_margin_detail_szse`　21. `stock_margin_underlying_info_szse`
