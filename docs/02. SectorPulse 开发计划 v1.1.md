# SectorPulse 项目进度计划（步骤版 · 带图标与勾选框）

> 面向"业余个人散户开发者"，以 **V3.1 状态机 + 闭环** 为蓝本；默认每步可按你空闲时间弹性推进（无硬性时限）。
> **对齐说明**：本计划全面对齐《00. SectorPulse 策略蓝图 v3.1》（Alt-Flow 口径）与《01. 项目开发文档 v1.2》（目录/配置/验收口径）
> 以**两融净偿还（EOD）+ 涨跌停比（盘中）+ 成交额集中度（盘中）**替代历史“北向净流”在**情绪闸门 / Kill-Switch**中的角色；
> 仅在 **10:00 / 14:00** 两个时窗执行交易分支。
---
> **版本**: v1.2 | **更新日期**: 2025-09-10 | **对齐**: 策略蓝图v3.1 + Alt-Flow口径
> **上版基线**：v1.1（沿用“步骤版”结构；本版完成 Alt-Flow 迁移与 DoD 细化）
---

## 🗺️ 总览 · 步骤清单（可勾选追踪）
- [✅] **步骤0｜基线就绪**（环境、仓库、配置模板）
- [✅] **步骤1｜可恢复骨架**（配置/数据库/调度框架）
- [✅] **步骤2｜盘前情绪闸门（Alt-Flow版）**（能否开新仓）
- [✅] **步骤3｜Kill-Switch 分级（Alt-Flow版）**（L1 停新单 / L2 清仓休眠）
- [ ] **步骤4｜状态机（含迟滞带+完整约束）**（进攻/持仓/观望/休眠）
- [ ] **步骤5｜选板→选股漏斗**（产出 1–5 只候选）
- [ ] **步骤6｜买点微结构 & 降级**（可执行/不可执行布尔判决）
- [ ] **步骤7｜下单意向 & 风控模板**（首仓10% + SL/TP 模板）
- [ ] **步骤8｜持仓管理**（时间止损 / 板块连续性）
- [ ] **步骤9｜纸上实盘·第1周**（信号→动作闭环 + 状态验证）
- [ ] **步骤10｜纸上实盘·第2周**（统计命中率/滑点/风控触发）
- [ ] **步骤11｜最小可视化**（Streamlit 看板）
- [ ] **步骤12｜参数微调 & 3.1 收口**

---

## 🔧 步骤0｜基线就绪（一次性）
**🎯 目标**：搭好最小开发跑道，不被环境问题卡住。  
**📦 产出**
- [✅] `README.md` 简版运行指南  
- [✅] `requirements.txt`（可不锁）+ 可选 `constraints.txt`（仅放灾难级上限，如 `pydantic<3`）  
- [✅] `config/base.yaml` `config/dev.override.yaml``config/strategy_core.yaml`模板（迟滞带、分级风控、时窗/时区、降级口径、交易日历项）
**✅ 验收（DoD）**
- [✅] 本地可 `python -m main` 启动空循环且无报错  
- [✅] `zoneinfo("Asia/Shanghai")` 可正常工作  
**⚠️ 风险/回退**
- [✅] 若数据/依赖版本冲突 → 先移除"强锁"，仅保留上限约束运行

---

## 🧱 步骤1｜可恢复骨架（配置/数据库/调度）
**🎯 目标**：**启动—运行—崩溃—重启**后，状态不丢。  
**📦 产出**
- [✅] 目录：`config/ /data_service/ /strategy_engine/ /models/ /utils/ /api/ /web_dashboard/`  
- [✅] 数据库 **7 张表**：`Account / Position / Transaction + Signal / OrderIntent / StateSnapshot / EventLog`  
- [✅] 调度器：Asia/Shanghai；**仅 10:00 / 14:00** 触发；交易日历缓存与降级策略。
**数据库核验清单（完成即勾 ✅）**   
    - [✅] StateSnapshot：写入 1 条、重启进程后能读取到最新一条（用于"恢复"）。
    - [✅] EventLog：写入 ≥ 1 条（有 level、code、payload），确保表非空。
    - [✅] 约束：OrderIntent.idempotency_key 唯一性生效（重复键会失败或被业务层拦截）。
    - [✅] 时区：任意新记录的 ts 与上海时间一致（误差秒级可接受）。
    - [✅] DB 目标：实际写入到你预期的数据库（本地 sqlite 或你配置的 DB_URL）。
- [✅] 调度器：`utils/scheduler.py`（仅 **10:00 / 14:00** 触发；交易日历过滤；`Asia/Shanghai`）
    **调度器验收标准（Acceptance Criteria）**
    - [✅] 1. 启动与停止事件
          - 调用 start_scheduler() 后，EventLog 必须出现一条 scheduler_start 事件，payload 含：
            -  tz, windows, jobstore_url, preheat_enabled
            -  calendar_* 字段（source/cached_at/fail_policy/degraded/staleness_days）
          - 调用 shutdown_scheduler() 后，EventLog 必须出现 scheduler_stop 事件。   
    - [✅] 2. 交易日历刷新与降级
          - 调用 refresh_trading_calendar() 后，必须产生以下之一：
            -  calendar_refresh_ok（AkShare 成功）
            -  calendar_use_cache（使用缓存，含 staleness_days 与 degraded）
            -  calendar_fallback_weekday / calendar_unavailable（无远端无缓存时的回退）
          - is_trading_day(today) 能返回布尔结果；当缓存存在且包含当天，返回应为 True。
          - 降级策略：当使用陈旧缓存（staleness_days > threshold）或回退时，calendar_degraded=True。
    - [✅] 3. 调度窗口行为（不依赖真实时间）
          - 在交易日 + 窗口内（10:00/14:00）条件下调用主任务：必落 scheduler_tick；payload 含 calendar_* 与 action=EXECUTE。
          - 在非交易日或窗口外条件下调用主任务：必落 scheduler_skip；payload 含 action=SKIP。
    - [✅] 4. 状态恢复
        - 预先插入一条 StateSnapshot 后，调用 restore_state_from_snapshot()，应返回该状态（用于"崩溃后恢复"）。
    - [✅] 5. 时区一致性
        - 所有测试内取得的 now 与事件 payload 中 tz 一致（默认为 Asia/Shanghai）。
### ✅ 验收
- [✅] 崩溃后重启可从 `StateSnapshot` 恢复  
- [✅] `EventLog` 有至少 1 条记录（level、code、payload）
  **⚠️ 风险/回退**
    - [✅] 1) 交易日历不可用或陈旧
          - 风险：AkShare 抽风或网络故障，导致交易日判定不准/不可用。
          - 检测信号（EventLog.code）：
              - 成功：calendar_refresh_ok（degraded=false）
              - 用缓存：calendar_use_cache（含 staleness_days、degraded）
              - 无缓存回退：calendar_fallback_weekday（fail_open）或 calendar_unavailable（fail_closed）  
          - 回退策略（已可配置）：
              - fail_open（默认）：按周一至周五认定交易日；标记降级 calendar_degraded=true
              - fail_closed：一律视为非交易日（最保守）  
          - 降级期的策略约束（由策略层读取标志执行）：
              - 不开新仓，仅执行持仓管理（止盈/止损/时间衰减）  
          - 恢复条件：calendar_refresh_ok 再次出现，degraded=false；或缓存 staleness_days ≤ 阈值。  
          - 相关配置：
              - scheduler.calendar_fail_policy: fail_open | fail_closed
              - scheduler.calendar_cache_stale_days: 7（可调）
    - [✅] 2) 调度时间窗与时区
        - 风险：机器非 +08:00 环境导致跑错时间。
        - 设计：业务/落库统一 ZoneInfo(Asia/Shanghai)；APScheduler 仅在 timezone= 使用 pytz。
        - 检测：所有事件 payload 包含 tz: "Asia/Shanghai"；时间戳 +08:00。
        - 回退：如发现错误，调整 runtime.tz 或环境变量 SECTORPULSE_TZ，重启即可生效。
    - [✅] 3) JobStore/调度器异常
        - 风险：SQLAlchemyJobStore 不可用或锁冲突（SQLite）。
        - 设计：失败自动回退至内存 JobStore；默认单独文件 ./sectorpulse_jobs.db 降低锁竞争。
        - 检测：scheduler_start payload 中 jobstore_url 与启动时日志。
        - 回退：设置 SECTORPULSE_JOBSTORE_URL 复用业务库或切换到更可靠的数据库；必要时删除损坏的 sectorpulse_jobs.db 重新生成。
    - [✅] 4) DB 写入失败（磁盘满、锁死）
        - 检测：EventLog 无新增、或抛出 SQL 错误；应用日志显示异常。
        - 回退：释放磁盘空间、确认 SQLite 未被其他进程长时间占用；重启进程。
        - 恢复：EventLog 重新产生 scheduler_start、scheduler_tick/skip。
    - [✅] 5) 进程异常退出
        - 风险：崩溃导致状态丢失。
        - 设计：以 StateSnapshot 为单事实源，重启调用 restore_state_from_snapshot() 恢复。
        - 检测：重启后第一条 scheduler_start 事件；手动跑一次 restore 测试也可验证。
        - 回退/恢复：无需手工干预，重启即恢复；必要时可人工写入一条 StateSnapshot 再重启。
### 验收后日常核验（简短命令）
  **快捷验证事件是否持续写入：**
  - sqlite3 sectorpulse.db "select ts,code,substr(payload_json,1,120) from eventlog order by id desc 

---

## 🌅 步骤2｜盘前情绪闸门（Alt-Flow版）
**🎯 目标**：当日仅在 10:00 / 14:00 两个时窗进行闸门布尔判定；盘前只生成背景指标，不参与当日放行判定  
**📦 产出**
- [✅] `check_emotion_gate()` → `{passed: bool, reasons: [...], indicators: {...}}`  
- [✅] **Alt-Flow 口径（闸门用“盘中项”，两融作“日终锚点”）：**
  - [✅] 涨跌停比（盘中实时）
  - [✅] 成交额集中度（盘中实时；如前20个股成交额占比）
  - （说明）上一交易日**两融净买入/净偿还（EOD）**仅作为**次日计划/复盘**的背景锚点，**不参与当日 `passed` 布尔判定**；可写入 `indicators` 供显示与记录
- [✅] 其他闸门条件：
  - [✅] 涨停家数
  - [✅] 波动分位（HS300 30D 年化）
  - [✅] 上证是否在 MA20 上方

**✅ 验收标准**
- [✅] **盘中（涨跌停比/成交额集中度）与结构/波动条件**全部通过才返回 `passed:true`
- [✅] 任一未通过时，`reasons` 明确列出指标名与实际数值
- [✅] 产生 `altflow/gate_pass` 或 `altflow/gate_reject` 事件；`indicators` 落库（包含两融EOD，但仅作背景记录，**不影响 `passed`**）

**⚠️ 风险/回退**
- [✅] 分钟数据缺失 → 返回 `passed:false, reason:"intraday_missing"`；当日仅执行**持仓管理**流程
- [✅] 两融数据缺失 → 仅在 `indicators` 中标注缺失，不影响当日 `passed` 判定

### 配置检查清单
- [✅] emotion_gate.limit_up_count_min 已配置
- [✅] emotion_gate.vol_percentile_max 已配置（建议0.85）
- [✅] emotion_gate.ma20_required 已配置
- [✅] emotion_gate.limitup_down_ratio_min 已配置（建议0.50）
- [✅] emotion_gate.turnover_concentration_max 已配置（建议0.40）

### 测试小节
#### 测试结果
  ~/SectorPulse v1.0$ python -m tests.11_test_step2_auto_check --prev 20250911 --window 10:00 --strict 
  - [OK] 配置清单：emotion_gate.* 键齐全且类型正确 
  - [OK] 真实指标计算完成（仅此一次触发外部获取） 
  - [OK] passed=True 
  - [OK] reasons 个数=0 
  - [OK] calc_at 为带时区时间 
  - [OK] indicators 结构齐全 
  - [OK] metrics 核心键齐全 
  - [OK] 验收一致性：gate reasons 与本地复算一致 
  - [WARN] 未在 JSONL 中找到本次 window 的 altflow/gate_*，可能采用了 DB 写入 
  - 2025-09-14 17:36:02,090 INFO sqlalchemy.engine.Engine BEGIN (implicit) 
  - 2025-09-14 17:36:02,103 INFO sqlalchemy.engine.Engine SELECT eventlog.id, eventlog.ts, eventlog.level, eventlog.code, eventlog.payload_json FROM eventlog ORDER BY eventlog.id DESC 
  - 2025-09-14 17:36:02,103 INFO sqlalchemy.engine.Engine [generated in 0.00225s] () 
  - 2025-09-14 17:36:02,106 INFO sqlalchemy.engine.Engine ROLLBACK 
  - [WARN] 未在 DB 最近记录中找到本次 window 的 altflow/gate_* 
  - [OK] INTRADAY_MISSING 场景：passed=False 且 reasons=['intraday_missing'] 
  - [OK] FORCED PASS/REJECT 场景：判定逻辑正确 
  - [OK] 严格模式：全部检查通过
#### 结论（是否达标）
  ✅ 配置清单：emotion_gate.* 键齐全且类型正确（通过配置验收）。
  ✅ 指标计算：真实指标完成（本次仅触发一次外部获取），后续检查均基于这份指标进行注入式验证。
  ✅ 闸门产出：passed=True、reasons 为空，calc_at 为带时区时间；indicators 与 metrics 结构完整（满足产出要求）。
  ✅ 一致性校验：用阈值在本地复算的 reasons 与闸门返回一致（说明判定逻辑与阈值对齐，满足验收标准的“明确理由”要求）。
  ✅ 风险/回退用例：
   - INTRADAY_MISSING 注入 → passed=False 且 reasons=['intraday_missing']（符合“分钟数据缺失→直接拒绝”的回退策略）。
   - 强制 PASS / REJECT 注入 → 均得到预期结果（判定边界与阈值如期生效）。
  ⚠️ 事件查验：未在默认 JSONL 路径或 DB 的最近记录中检出本次窗口的 altflow/gate_*（警告，不影响本脚本的“严格模式通过”）。
#### 细项解读
  1. 为什么是 passed=True 且 reasons=0？
      说明在当前阈值下（你配置的是 limit_up_count_min=30、limitup_down_ratio_min=0.50、turnover_concentration_max=0.35、vol_percentile_max=0.75、ma20_required=true），所有参与闸门的“盘中项 + 结构/波动”条件均满足，因此放行。
  2. 一致性检查通过意味着什么？
      用同一套阈值对 metrics 做独立复算，得到的拒绝理由与闸门返回完全一致，说明：
      -  指标口径与阈值读取一致；
      -  判定函数与测试脚本对“>= / <= / must-be-true”的理解一致；
      -  “两融”指标仅做背景记录，不参与 passed 判定的约束被正确执行
  3. 脚本按两条路径查事件：
        a) events/altflow_events.jsonl（JSONL 降级文件）；
        b) EventLog 数据表。
      本次都未命中，常见原因有三类（任选其一即可解释）：
        storage 中确实存在事件写入函数，但其写入位置与本脚本默认查找位置不同（例如写入了自定义 JSONL 路径、或写了其它事件表/库）。
        当前运行环境的 DB_URL/实例不一致：事件写入与脚本查询使用了不同的数据库（或 schema），因此查询不到。
        事件写入在 storage 内部被吞错/短路（我们对 writer 做了签名自适配并捕获异常，不会影响主流程，但也可能因此静默失败）。
      这是“软性检查”，不影响闸门判定与 P0 验收；等你需要时，我们再对齐事件落点并做一次针对性验证。
  4. 建议的最小后续核对（可选）
        确认 emotion_gate.check_emotion_gate(..., emit_event=True) 实际使用的事件落点：
        data_service.storage 是否实现了下列任一函数（按优先级）：append_event_jsonl / write_event / log_event / append_event？
        若实现了，它写到哪里（文件路径或数据库表）？把测试脚本里的查找目标对齐到该落点即可。
        若未实现，上述逻辑会自动降级到 events/altflow_events.jsonl；确保当前工作目录有写权限。 
---

## 🚨 步骤3｜Kill-Switch 分级（Alt-Flow版）
**🎯 目标**：极端风险来时**自动"停新单/清仓休眠"**。  
**📦 产出**
- [✅] `check_kill_switch()` → `{level: 0|1|2, triggered_conditions: [...], actions: [...]}`   
- [✅] **L1触发条件（满足任一）**：
  - [✅] 两融净偿还 ≥ L1阈值（如100亿）
  - [✅] 涨跌停比 < L1阈值（如0.50）
  - [✅] 成交额集中度 > L1阈值 且 指数下跌
  - [✅] 波动分位 ≥ 0.85
- [✅] **L2触发条件（满足任一）**：
  - [✅] 两融净偿还 ≥ L2阈值（如200亿）
  - [✅] 涨跌停比 < L2阈值（如0.20）
  - [✅] 成交额集中度 > L2阈值 且 指数显著下跌
  - [✅] 波动分位 ≥ 0.90
- [✅] **动作**
- [✅] L1 停新单 + 总仓上限降至 30%；L2 清仓并进入休眠态 
    **实现：**代码中已落地（actions 包含 stop_new_reduce_cap 与 temp_total_cap=0.30；调用 set_position_cap）。
    **证据缺口：**目前**未在“真实 KS 触发路径 + emit_event=True”**的场景下观测到 position_cap=0.30 的状态变化（离线注入用例为了纯判定，
                 emit_event=False 不执行动作；在线/调度 E2E 这两天未出现 L1 真实触发）。
    **结论：**逻辑已实现，E2E 动作生效的观测待补（需要一次 L1 真实/注入触发且 emit_event=True，读取 DB/runtime_state.json 验证）。
- [✅] L2：清仓并进入休眠态
    **实现：**代码中已落地（actions 包含 force_liquidation 与 sleep_mode；调用 enter_sleep_mode）。
    **证据缺口：**2025-09-17 在线实测已触发 L2，但 13_system_flow_cli 当前只打印 KS 结果，未读取状态位确认 sleeping=True 或清仓指令下达的副作用；
                 此前在 12_test_kill_switch.py 的“重启机制”环节是手动调用 enter_sleep_mode 后验证的 exit_sleep_mode()，
                 不等同于“KS L2 动作链路自动入睡”的观测。
    **结论：**逻辑已实现，E2E 动作生效的观测待补（需要在 L2 触发当次，读取状态位与事件）。
- [✅] **重启机制实现**（休眠态专用）：
  - [✅] 每日自动检查重启条件
  - [✅] **连续 3 个交易日**闸门通过 且 **月度回撤 ≥ -3%** 即“可重启”；
  - [✅] 可选：人工确认接口
**✅ 验收标准**
- [✅] 触发L1时：落 `altflow/ks_L1` 事件落库，payload 含触发条件与数值；仓位上限即时生效
- [✅] 触发L2时：落 `altflow/ks_L2` 事件落库，并触发清仓流程；入休眠态
- [✅] 重启：产生 `restart/eligible` 事件与最终 `restart/confirm`（如需人工）
**⚠️ 风险/回退**
- [✅] 阈值过敏感/过钝 → 在步骤9/10 纸上实盘中调参回补

### 配置检查清单
- [✅] kill_switch.L1 所有条件和action已配置
- [✅] kill_switch.L2 所有条件和action已配置
- [✅] restart_conditions.consecutive_gate_days 已配置（建议3）
- [✅] restart_conditions.monthly_drawdown_threshold 已配置（建议-0.03）
- [✅] restart_conditions.manual_confirm 已配置

---

## 🔁 步骤4｜状态机（含迟滞带+完整约束）
**🎯 目标**：仓位与闸门共同驱动四态，**不抖动**，**约束完整**。  
**📦 产出**
- [ ] `decide_state(emotion_pass, position_ratio, ks_level, current_state) -> {state, reason}`  
- [ ] **状态定义与约束**：
  - [ ] 进攻态：情绪通过 且 仓位<60%（迟滞：进入<55%，退出≥65%）
  - [ ] 持仓态：情绪通过 且 仓位≥60%
  - [ ] 观望态：情绪未通过 且 **仓位≤30%**（重要约束）
  - [ ] 休眠态：Kill-Switch L2触发
- [ ] **特殊处理**：
  - [ ] 情绪未通过但仓位>30% → 保持在持仓态（不能进入观望态）
  - [ ] 休眠态需检查重启条件才能退出
**✅ 验收标准**
- [ ] 58-62%仓位边界不频繁切换（迟滞带生效）
- [ ] 观望态仅在仓位≤30%时进入，否则停留在持仓态
- [ ] `state/change` 事件记录：from_state、to_state、trigger_reason
- [ ] 每个状态都有明确的允许操作列表
**⚠️ 风险/回退**
- [ ] 迟滞带过大导致反应迟钝 → 缩小到5%区间
- [ ] 观望态30%限制过严 → 可临时放宽到40%

### 配置检查清单
- [ ] state_machine.pos_band.enter_offense 已配置（建议0.55）
- [ ] state_machine.pos_band.exit_offense 已配置（建议0.65）
- [ ] observe_state.position_threshold 已配置（建议0.30）
- [ ] 四种状态的转换条件都已明确

---

## 🧭 步骤5｜选板→选股漏斗
**🎯 目标**：**10:00 / 14:00** 各产出 0–5 只候选（可为 0，但要有原因）。  
**📦 产出**
- [ ] 行业板强度排序第 3–5 名 → 板内个股 第 3–5 名（不含第 1–2 名与第 6 名以后）  
- [ ] 约束：10 日均额 5–10 亿、RS ≥ 0.75；EV / RR / Pwin 兜底  
- [ ] 越界即拒绝：若候选涉及非 3–5 名，设 passed=false，reason_reject=rank_out_of_range
- [ ] Signal 表记录：通过/拒绝及 reason_reject；payload 落库 sector_rankings_snapshot 与 selected_candidates（含当次板块强度完整排序与被选 3–5 名明细）
**✅ 验收标准**
- [ ] 每个时窗都有结构化候选结果（哪怕 0 只）
- [ ] 拒绝原因分类清晰（流动性 / RS / EV 等）
- [ ] 严格命中 3–5 名强约束（抽样核验无越界）
- [ ] 排序与命中清单可追溯：可自 Signal.payload 复原当次行业排名与被选 3–5 名明细

---

## 🎯 步骤6｜买点微结构 & 降级
**🎯 目标**：把"可执行/不可执行"变为**明确布尔判决**。  
**📦 产出**
- [ ] `confirm_entry(symbol) -> {executable:bool, checks:{vwap_ok, volratio_ok, near_dayhigh_ok}, reason?, ref_prices}`  
- [ ] 标准：VWAP±0.5% / 5分钟量比>2 / 距当日高点<2%  
- [ ] **分钟数据缺失** → `executable=false, reason="intraday_missing"`（允许退化口径但不"猜成交"）
**✅ 验收标准**
- [ ] 每只候选均有明确 `executable` 与 `reason`
- [ ] 降级时标记 `degraded=true`
- [ ] ref_prices 包含决策依据的价格点

---

## 🧾 步骤7｜下单意向 & 风控模板
**🎯 目标**：一键生成**首仓10% + SL/TP 模板**。  
**📦 产出**
- [ ] `propose_order(symbol, side, fraction=0.10)` → `OrderIntent`（含幂等键）  
- [ ] 约束检查：
  - [ ] 单股不超20%
  - [ ] 总仓不超60%（L1时降至30%）
- [ ] 风控模板：SL −4%，TP1 +8%（减半）、TP2 +15%（清仓）
**✅ 验收标准**
- [ ] 进攻态且 `executable=true` 的候选，均能生成一致模板
- [ ] 仓位超限时拒绝并记录原因
- [ ] OrderIntent 包含完整的风控预设

### 配置检查清单
- [ ] position_management.stop_loss 已配置（建议-0.04）
- [ ] position_management.take_profit_1 已配置（建议0.08）
- [ ] position_management.take_profit_2 已配置（建议0.15）
- [ ] state.caps.max_single_position 已配置（建议0.20）
- [ ] state.caps.max_total_position 已配置（建议0.60）

---

## 🧭 步骤8｜持仓管理（时间止损/板块连续性）
**🎯 目标**：让利润奔跑，同时控制时间成本与板块风险。  
**📦 产出**
- [ ] `manage_positions()`实现：
  - [ ] T+3 观察警告
  - [ ] T+5 强制清仓
  - [ ] 板块连续性：**连续2日**退出Top3 → 触发"止盈优先"
- [ ] 观望态特殊处理：
  - [ ] 更激进的止损（如-3%）
  - [ ] 浮盈回撤>20%即止盈
**✅ 验收标准**
- [ ] 每个持仓日终都有"保留/减仓/清仓"决策记录
- [ ] 时间衰减触发时产生 `position/time_decay` 事件
- [ ] 板块退出Top3产生警告日志

---

## 🧪 步骤9｜纸上实盘 · 第1阶段（5个交易日）
**🎯 目标**：不改逻辑，仅用真行情跑**信号→动作**闭环，验证状态机。  
**📦 产出**
- [ ] 日报（Markdown）：
  - [ ] 今日状态及转换
  - [ ] 候选股及拒绝原因
  - [ ] 意向单及风控设置
  - [ ] 持仓处置决策
  - [ ] Alt-Flow各指标值
  - [ ] Kill-Switch触发情况
**额外验证项**
- [ ] 观望态是否正确触发（仓位>30%时应保持持仓态）
- [ ] Kill-Switch L1/L2触发后的状态转换是否正确
- [ ] 休眠态的重启条件检查是否每日执行
- [ ] 迟滞带在仓位58-62%区间是否稳定
**✅ 验收标准**
- [ ] 5日内至少触发过2种不同状态
- [ ] 得到初步指标：信号数、拒绝率、状态分布

---

## 📊 步骤10｜纸上实盘 · 第2阶段（再5个交易日）
**🎯 目标**：补足样本，稳定统计口径，重点测试极端场景。  
**📦 产出**
- [ ] 累积10日统计：
  - [ ] 状态转换频率
  - [ ] Alt-Flow触发频率
  - [ ] Kill-Switch触发次数
  - [ ] 拒绝原因Top3
  - [ ] 假设的收益曲线
**压力测试项**
- [ ] 人为触发Kill-Switch L1/L2（修改阈值）
- [ ] 测试休眠态重启流程
- [ ] 测试观望态30%仓位约束
**✅ 验收标准**
- [ ] 形成完整的10日运行报告
- [ ] 识别出需要调整的参数

---

## 🖼️ 步骤11｜最小可视化（Streamlit）
**🎯 目标**：一页看清"状态/候选/原因/持仓/风控"。  
**📦 产出**
- [ ] 五大模块：
  1. [ ] **系统状态卡**：当前状态、仓位、Alt-Flow指标
  2. [ ] **情绪闸门卡**：“盘中（涨跌停比/成交额集中度）与结构/波动条件全部通过才返回 `passed:true`；两融（EOD）仅记录在 `indicators` 中，不参与当日布尔判定。”
  3. [ ] **候选股表**：含拒绝原因
  4. [ ] **持仓管理表**：含时间计数、浮盈浮亏
  5. [ ] **风控监控卡**：Kill-Switch级别、重启条件进度
**✅ 验收标准**
- [ ] 本地 `streamlit run web_dashboard/app.py` 可启动
- [ ] 页面刷新≤30秒
- [ ] 所有数据从数据库读取（非硬编码）

---

## 🧩 步骤12｜参数微调 & 3.1 收口
**🎯 目标**：基于10日纸上实盘数据，优化参数。  
**📦 产出**
- [ ] 参数调优报告：
  - [ ] Alt-Flow阈值建议
  - [ ] 迟滞带宽度建议
  - [ ] Kill-Switch灵敏度评估
  - [ ] 观望态仓位阈值评估
- [ ] 更新后的 `strategy_core.yaml`
- [ ] 《纸上实盘2周复盘报告》
**✅ 验收标准**
- [ ] 所有建议参数都有数据支撑
- [ ] 配置文件版本号更新（如v3.2）
- [ ] 形成参数调整的变更日志

---

## ⚙️ 附录A · 完整配置模板（strategy_core.yaml）

```yaml
# SectorPulse Strategy Core Configuration v3.1
# 对齐 Alt-Flow 口径

# —— 状态机：迟滞带与约束 —— 
state_machine: 实际执行采用 55%/65% 迟滞带
  pos_band:
    enter_offense: 0.55      # <55% 进入进攻态
    exit_offense: 0.65       # ≥65% 退出进攻态
  caps:
    max_total_position: 0.60
    max_single_position: 0.20
    initial_entry_fraction: 0.10
  board_continuity_days: 2
  cool_down_days: 2

# —— 观望态配置 ——
observe_state:
  position_threshold: 0.30    # 观望态仓位上限
  aggressive_stop_loss: -0.03 # 更严格的止损
  profit_retracement_max: 0.20 # 浮盈回撤超20%即止盈

# —— 状态转移条件 —— 
state_transition:
  to_offense: { emotion_gate: true, position_ratio_max: 0.55 }
  to_hold:    { emotion_gate: true, position_ratio_min: 0.65 }
  to_watch:   { emotion_gate: false, position_ratio_max: 0.30 }
  to_sleep:   { kill_switch_level: 2 }

# —— 盘前情绪闸门（Alt-Flow版）——
emotion_gate:
  # 市场结构条件
  limit_up_count_min: 50            # 涨停家数 ≥ 50
  ma20_required: true              # 上证必须在MA20上方
  
  # Alt-Flow情绪指标（盘中）
  limitup_down_ratio_min: 0.50     # 涨跌停比 > 0.50
  turnover_concentration_max: 0.40  # 成交额集中度 < 0.40
  
  # 波动条件
  vol_percentile_max: 0.85         # 30日波动分位 < 0.85
  
  # 检查时机
  check_timing:
    pre_market: true               # 盘前只做背景/可视化检查（写入 indicators），不以EOD两融参与当日布尔判定
    intraday: ["10:00", "14:00"]  # 当日实际闸门判定仅在两个盘中时点执行

# —— 波动率代理（无QVIX）——
volatility_proxy:
  index: "CSI300"
  window_days: 30
  lookback_days: 252
  percentile_method: "rolling"

# —— Kill-Switch分级（Alt-Flow版）——
kill_switch:
  L1:
    # 触发条件
    margin_net_repay_yi: 100         # 两融净偿还阈值
    limitup_down_ratio_min: 0.50     # 涨跌停比阈值
    turnover_concentration_max: 0.40 # 成交额集中度阈值
    vol_percentile_min: 0.85         # 波动分位阈值
    # 触发动作
    action: "stop_new"                # 主动作
    temp_total_cap: 0.30             # 临时仓位上限
    tighten_stop_loss: -0.03        # 收紧止损
    
  L2:
    # 触发条件
    margin_net_repay_yi: 200
    limitup_down_ratio_min: 0.20
    turnover_concentration_max: 0.45
    vol_percentile_min: 0.90
    # 触发动作
    action: "liquidate_sleep"        # 主动作

# —— 休眠态重启条件 ——
restart_conditions:
  consecutive_gate_days: 3           # 需连续通过闸门天数
  monthly_drawdown_threshold: -0.03  # 月度回撤修复阈值（-3%）
  manual_confirm: false              # 是否需要人工确认

# —— 当日回撤风控 —— 
daily_risk:
  max_intraday_drawdown: -0.02
  action_on_max_dd: "stop_new"

# —— 买点微结构与降级 —— 
microstructure_thresholds:
  vwap_deviation_abs_max: 0.005
  volratio_min: 2.0
  dist_to_day_high_max: 0.02
  
intraday_fallback:
  allow_fallback: true
  on_missing: "mark_unexecutable"
  vwap_fallback: "cum_turnover/cum_volume"
  volratio_fallback: "vol_5min / mean(vol_60_120min_recent5d)"
  near_dayhigh_fallback: "last / day_high_ref - 1"

# —— 持仓管理 —— 
position_management:
  stop_loss: -0.04
  take_profit_1: 0.08
  take_profit_2: 0.15
  time_decay: 
    t3_alert: true
    t5_force_close: true
  sector_continuity: 
    check_interval: "daily"
    exit_top3_days: 2

# —— 执行窗口配置 ——
# 统一为主口径（01和02都使用）
execution:
  windows: ["10:00", "14:00"]    # 决策时间窗口（必需）
  tz: "Asia/Shanghai"             # 时区（必需）

# 扩展配置（仅在02附录中标注为"可选扩展"）
execution_extended:  # 可选，loader暂不消费
  trading_windows:
    morning: 
      start: "09:30"
      end: "11:30"
    afternoon:
      start: "13:00"  
      end: "14:57"
  tail_session:
    start: "14:45"
    actions_allowed: ["sell", "stop_loss"]

# —— 监控与告警 ——
monitoring:
  performance_alerts: 
    daily_loss_threshold: -0.03
    weekly_loss_threshold: -0.08
  system_alerts:      
    data_delay_max_minutes: 5
    execution_delay_max_seconds: 30
  notify: 
    enabled: false
    channels: []

# —— 交易日历配置 ——
calendar:
  market: "SSE_SZSE"
  holidays_source: "akshare"
  cache_days: 30
  fail_policy: "fail_open"  # fail_open | fail_closed
  stale_threshold_days: 7
```

---

## 📋 附录B · 关键函数接口定义（参考）

```python
# 情绪闸门检查
def check_emotion_gate() -> dict:
    """
    Returns:
        {
            'passed': bool,
            'reasons': [...],  # 未通过的原因列表
            'indicators': {
                'limit_up_count': int,
                'limitup_down_ratio': float,
                'turnover_concentration': float,
                'vol_percentile': float,
                'ma20_position': bool,
                'margin_net_repay_yi': float  # 两融净流（亿），“正数=净偿还（收缩），负数=净买入（扩张）”
            }
        }
    """
    pass

# Kill-Switch检查
def check_kill_switch() -> dict:
    """
    Returns:
        {
            'level': 0|1|2,  # 0=正常, 1=L1, 2=L2
            'triggered_conditions': [...],  # 触发的具体条件
            'actions': [...]  # 需要执行的动作列表
        }
    """
    pass

# 状态决策
def decide_state(emotion_pass: bool, 
                position_ratio: float, 
                ks_level: int,
                current_state: str) -> dict:
    """
    Returns:
        {
            'state': str,  # 'OFFENSE'|'HOLDING'|'OBSERVE'|'SLEEP'
            'reason': str  # 状态决策原因
        }
    """
    pass

# 买点确认
def confirm_entry(symbol: str) -> dict:
    """
    Returns:
        {
            'executable': bool,
            'checks': {
                'vwap_ok': bool,
                'volratio_ok': bool,
                'near_dayhigh_ok': bool
            },
            'reason': str|None,  # 不可执行的原因
            'ref_prices': {...},  # 参考价格
            'degraded': bool  # 是否使用降级口径
        }
    """
    pass

# 重启条件检查
def check_restart_conditions() -> dict:
    """
    Returns:
        {
            'eligible': bool,
            'consecutive_gate_days': int,
            'monthly_drawdown': float,
            'details': str  # 详细说明
        }
    """
    pass
```

---

## 📊 附录C · 事件代码规范

```python
# 事件代码命名规范
EVENT_CODES = {
    # Alt-Flow相关
    'altflow/gate_pass': '情绪闸门通过',
    'altflow/gate_reject': '情绪闸门未通过',
    'altflow/ks_L1': 'Kill-Switch L1触发',
    'altflow/ks_L2': 'Kill-Switch L2触发',
    
    # 状态转换
    'state/change': '状态转换',
    'state/to_offense': '转入进攻态',
    'state/to_holding': '转入持仓态',
    'state/to_observe': '转入观望态',
    'state/to_sleep': '转入休眠态',
    
    # 重启相关
    'restart/check': '重启条件检查',
    'restart/eligible': '满足重启条件（等待确认）',
    'restart/executed': '执行重启（含自动或手动确认后）',
    
    # 仓位管理
    'position/open': '开仓',
    'position/close': '平仓',
    'position/stop_loss': '止损',
    'position/take_profit': '止盈',
    'position/time_decay': '时间衰减',
    
    # 系统事件
    'system/start': '系统启动',
    'system/shutdown': '系统关闭',
    'system/error': '系统错误',
    'system/recover': '系统恢复',
    
    # 调度器相关（下划线，因为是单一事件）
    'scheduler_start': '调度器启动',
    'scheduler_stop': '调度器停止',
    'scheduler_tick': '调度器执行',
    'scheduler_skip': '调度器跳过',

    # 日历相关
    'calendar_refresh_ok': '交易日历刷新成功',
    'calendar_use_cache': '使用缓存日历',
    'calendar_fallback_weekday': '日历降级',
    'calendar_unavailable': '日历不可用',
}
```

---

## 🎯 附录D · 部署前最终检查清单

### 系统完整性
- [ ] 所有12个步骤的核心功能已实现
- [ ] 配置文件包含所有必需项
- [ ] 数据库7张表结构正确
- [ ] 调度器在正确时间窗口触发

### Alt-Flow口径
- [ ] 两融数据获取正常
- [ ] 涨跌停比计算正确
- [ ] 成交额集中度计算正确
- [ ] 降级机制已实现

### 状态机约束
- [ ] 观望态30%仓位限制生效
- [ ] 迟滞带防抖动正常
- [ ] 休眠态重启条件检查正常
- [ ] 状态转换事件记录完整

### 风控机制
- [ ] Kill-Switch L1/L2触发正确
- [ ] 止盈止损模板生成正确
- [ ] 时间衰减T+3/T+5执行正确
- [ ] 板块连续性检查正常

### 监控告警
- [ ] EventLog事件记录完整
- [ ] StateSnapshot状态保存正常
- [ ] 关键指标可追溯
- [ ] 异常情况有日志

### 纸上实盘准备
- [ ] 测试数据源稳定
- [ ] 日报生成脚本就绪
- [ ] 性能统计口径明确
- [ ] 参数调优框架准备

---

**文档完成** ✅ 市场结构条件
  limit_up_count_min: 50            # 涨停家数 ≥ 50
  ma20_required: true              # 上证必须在MA20上方
  
  # Alt-Flow情绪指标（盘中）
  limitup_down_ratio_min: 0.50     # 涨跌停比 > 0.50
  turnover_concentration_max: 0.40  # 成交额集中度 < 0.40
  
  # 波动条件
  vol_percentile_max: 0.85         # 30日波动分位 < 0.85
  
  # 检查时机
  check_timing:
    pre_market: true               # 盘前只做背景/可视化检查（写入 indicators），不以EOD两融参与当日布尔判定
    intraday: ["10:00", "14:00"]  # 当日实际闸门判定仅在两个盘中时点执行

# —— 波动率代理（无QVIX）——
volatility_proxy:
  index: "CSI300"
  window_days: 30
  lookback_days: 252
  percentile_method: "rolling"

# —— Kill-Switch分级（Alt-Flow版）——
kill_switch:
  L1:
    conditions:
      margin_net_repay_yi: 100        # 两融净偿还 ≥ 100亿
      limitup_down_ratio_min: 0.50    # 涨跌停比 < 0.50
      turnover_concentration_max: 0.40 # 成交额集中度 > 0.40
      vol_percentile_min: 0.85        # 波动分位 ≥ 0.85
    actions:
      stop_new_positions: true        # 停止开新仓
      temp_total_cap: 0.30            # 临时降低总仓上限
      tighten_stop_loss: -0.03       # 收紧止损
      
  L2:
    conditions:
      margin_net_repay_yi: 200        # 两融净偿还 ≥ 200亿
      limitup_down_ratio_min: 0.20    # 涨跌停比 < 0.20
      turnover_concentration_max: 0.45 # 成交额集中度 > 0.45
      vol_percentile_min: 0.90        # 波动分位 ≥ 0.90
    actions:
      immediate_liquidation: true     # 立即清仓
      enter_sleep_mode: true          # 进入休眠态

# —— 休眠态重启条件 ——
restart_conditions:
  consecutive_gate_days: 3           # 需连续通过闸门天数
  monthly_draw